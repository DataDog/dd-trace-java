version: '3.8'

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.3
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      KAFKA_OPTS: "-Dzookeeper.4lw.commands.whitelist=ruok"
    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc localhost 2181 | grep imok"]
      interval: 5s
      timeout: 5s
      retries: 10

  kafka:
    image: confluentinc/cp-kafka:7.5.3
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list || exit 1"]
      interval: 5s
      timeout: 10s
      retries: 20

  mock-agent:
    build:
      context: .
      dockerfile: Dockerfile.mock-agent
    ports:
      - "8126:8126"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8126/info\")'"]
      interval: 5s
      timeout: 5s
      retries: 10

  app:
    build:
      context: .
      dockerfile: Dockerfile.app
    depends_on:
      kafka:
        condition: service_healthy
      mock-agent:
        condition: service_healthy
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      DD_AGENT_HOST: mock-agent
      DD_TRACE_AGENT_PORT: "8126"
      DD_DATA_STREAMS_ENABLED: "true"
      DD_SERVICE: dsm-kafka-config-test
      DD_ENV: dsm-qa-test
      DD_VERSION: "1.0.0"
    volumes:
      # Mount the locally-built tracer jar
      - ../dd-java-agent/build/libs/dd-java-agent-1.60.0-SNAPSHOT.jar:/agent/dd-java-agent.jar:ro
