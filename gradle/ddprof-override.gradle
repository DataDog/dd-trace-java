// Configuration for using ddprof snapshot versions
// When -PddprofUseSnapshot=true is set, this will:
// 1. Parse the current ddprof version from libs.versions.toml
// 2. Calculate the next minor snapshot version: X.Y.Z -> X.(Y+1).0-SNAPSHOT
// 3. Override the ddprof dependency resolution to use the snapshot version
// 4. Add a qualifier to the dd-trace-java version to avoid overwriting standard snapshots

def ddprofUseSnapshot = project.hasProperty('ddprofUseSnapshot') && project.property('ddprofUseSnapshot').toBoolean()

if (ddprofUseSnapshot) {
  def ddprofSnapshotVersion = calculateDdprofSnapshotVersion()
  logger.lifecycle("Using ddprof snapshot version: ${ddprofSnapshotVersion}")

  // Store the calculated version as an extra property for use in subprojects
  rootProject.ext.ddprofSnapshotVersion = ddprofSnapshotVersion

  // Add qualifier to the project version to differentiate from standard snapshots
  // This ensures we don't overwrite the regular SNAPSHOT artifacts
  allprojects {
    def originalVersion = version.toString()
    if (originalVersion.contains('-SNAPSHOT')) {
      // Insert qualifier before -SNAPSHOT: X.Y.Z-SNAPSHOT -> X.Y.Z-ddprof-SNAPSHOT
      version = originalVersion.replace('-SNAPSHOT', '-ddprof-SNAPSHOT')
    } else if (originalVersion.contains('-')) {
      // For versions with trailer: X.Y.Z-12-g8ab3f42d -> X.Y.Z-ddprof-12-g8ab3f42d
      def parts = originalVersion.split('-', 2)
      version = "${parts[0]}-ddprof-${parts[1]}"
    } else {
      // For release versions (shouldn't happen, but handle it): X.Y.Z -> X.Y.Z-ddprof
      version = "${originalVersion}-ddprof"
    }
    logger.lifecycle("Modified version for ${project.name}: ${originalVersion} -> ${version}")
  }

  // Override the ddprof dependency resolution for all configurations
  allprojects {
    configurations.all {
      resolutionStrategy.eachDependency { DependencyResolveDetails details ->
        if (details.requested.group == 'com.datadoghq' && details.requested.name == 'ddprof') {
          details.useVersion(ddprofSnapshotVersion)
          details.because("Using ddprof snapshot version for integration testing")
        }
      }
    }
  }
}

def calculateDdprofSnapshotVersion() {
  // Read the libs.versions.toml file
  def versionsFile = rootProject.file('gradle/libs.versions.toml')
  if (!versionsFile.exists()) {
    throw new GradleException("Could not find gradle/libs.versions.toml")
  }

  def currentVersion = null
  versionsFile.eachLine { line ->
    // Look for the ddprof version line: ddprof = "X.Y.Z"
    def matcher = line =~ /^\s*ddprof\s*=\s*"([0-9]+)\.([0-9]+)\.([0-9]+)"\s*$/
    if (matcher) {
      def major = matcher[0][1]
      def minor = matcher[0][2]
      // Increment the minor version
      def nextMinor = (minor as Integer) + 1
      currentVersion = "${major}.${nextMinor}.0-SNAPSHOT"
    }
  }

  if (currentVersion == null) {
    throw new GradleException("Could not parse ddprof version from gradle/libs.versions.toml")
  }

  return currentVersion
}
