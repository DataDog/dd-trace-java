apply plugin: 'com.github.spotbugs'

spotbugs {
  ignoreFailures = true
  excludeFilter = file("$rootDir/gradle/spotbugFilters/exclude.xml")
}

spotbugsMain {
  ignoreFailures = false
  // detector documentation is in the following link:
  // https://spotbugs-in-kengo-toda.readthedocs.io/en/lqc-list-detectors/detectors.html
  omitVisitors = [
    'DefaultEncodingDetector',
    'DoInsideDoPrivileged',
    'DontUseEnum',
    'DroppedException',
    'FindDeadLocalStores',
    'FindHEmismatch',
    'FindNullDeref',
    'FindReturnRef',
    'FindRunInvocations',
    'FindUselessControlFlow',
    'InitializationChain',
    'LazyInit',
    'LoadOfKnownNullValue',
    'LostLoggerDueToWeakReference',
    'MethodReturnCheck',
    'MutableStaticFields',
    'Naming',
    'RuntimeExceptionCapture',
    'SerializableIdiom',
    'UnreadFields',
  ]
  reports {
    html {
      enabled = true
      destination = file("$buildDir/reports/spotbugs/spotbugsMain.html")
      stylesheet = 'fancy-hist.xsl'
    }
  }
}

dependencies {
  compileOnly 'net.jcip:jcip-annotations:1.0'
  compileOnly 'com.github.spotbugs:spotbugs-annotations:4.2.0'

  testCompile 'net.jcip:jcip-annotations:1.0'
  testCompile 'com.github.spotbugs:spotbugs-annotations:4.2.0'
}

afterEvaluate {
  tasks.withType(spotbugsTest.class).configureEach {
    def name = it.name
    if (name.endsWith("Test")) {
      omitVisitors = [
        'DefaultEncodingDetector',
        'DoInsideDoPrivileged',
        'DumbMethods',
        'FindBadCast2',
        'FindDeadLocalStores',
        'FindNullDeref',
        'FindReturnRef',
        'FindUseOfNonSerializableValue',
        'InconsistentAnnotations',
        'InvalidJUnitTest',
        'LazyInit',
        'MethodReturnCheck',
        'MutableStaticFields',
        'Naming',
        'OverridingEqualsNotSymmetrical',
        'SerializableIdiom',
        'UncallableMethodOfAnonymousClass',
        'UnreadFields',
      ]
      ignoreFailures = false
      reports {
        html {
          enabled = true
          destination = file("$buildDir/reports/spotbugs/${name}.html")
          stylesheet = 'fancy-hist.xsl'
        }
      }
    }
  }
}
