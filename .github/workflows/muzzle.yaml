# Source: https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/master/.github/workflows/pr.yaml

name: Muzzle build

on: pull_request

jobs:
  setup-muzzle-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v2
      - name: Set up JDK 11 for running Gradle
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - id: set-matrix
        run: echo "::set-output name=matrix::{\"module\":[\"$(./gradlew -q :dd-java-agent:instrumentation:enumerate | xargs echo | sed 's/ /","/g')\"]}"

  muzzle:
    needs: setup-muzzle-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJson(needs.setup-muzzle-matrix.outputs.matrix)}}
      fail-fast: false
    steps:
      - name: Check out repository
        uses: actions/checkout@v2
      - name: Set up JDK 11 for running Gradle
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Set JDK 11 home
        run: echo JAVA_11_HOME=${{ env.JAVA_HOME }} >> $GITHUB_ENV
      - name: Run  muzzle
        run: ./gradlew ${{ matrix.module }}:muzzle --no-daemon
