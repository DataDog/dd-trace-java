ci-visibility-test-environment:
  stage: publish
  image: registry.ddbuild.io/images/dd-octo-sts-ci-base:2025.06-1
  tags: [ "arch:amd64" ]
  needs: [ publish-artifacts-to-s3 ]
  id_tokens:
    DDOCTOSTS_ID_TOKEN:
      aud: dd-octo-sts
  rules:
    - if: '$POPULATE_CACHE'
      when: never
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH !~ /^(master|release\/)/'
      when: on_success
    - when: never
  before_script:
    - dd-octo-sts version
    - dd-octo-sts debug --scope DataDog/dd-trace-java --policy self.gitlab.github-access.read
    - dd-octo-sts token --scope DataDog/dd-trace-java --policy self.gitlab.github-access.read > github-token.txt
    - gh auth login --with-token < github-token.txt
  script:
    - .gitlab/ci_visibility_generate_job.sh
  after_script:
    - dd-octo-sts revoke -t $(cat github-token.txt) || true
  artifacts:
    paths:
    - ci-visibility-test-environment.yml
  retry:
    max: 2
    when: always

ci-visibility-test-environment-trigger:
  stage: publish
  needs:
    - job: ci-visibility-test-environment
  rules:
    - if: '$POPULATE_CACHE'
      when: never
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH !~ /^(master|release\/)/'
      when: on_success
    - when: never
  trigger:
    include:
      - artifact: ci-visibility-test-environment.yml
        job: ci-visibility-test-environment
    strategy: depend
