include:
  - remote: https://gitlab-templates.ddbuild.io/libdatadog/include/single-step-instrumentation-tests.yml

oci-internal-publish:
  extends: .oci-internal-publish
  stage: package
  needs: [ package-oci ]
  rules:
    - when: on_success
  variables: 
    FLAVOR: datadog-apm-library-java

oci-internal-test-ecr-publish:
  stage: package
  needs: [ oci-internal-publish ]
  rules:
    - when: on_success
  trigger:
    project: DataDog/public-images
    branch: main
    strategy: depend
  variables:
    IMG_SOURCES: registry.ddbuild.io/ci/remote-updates/datadog-apm-library-java:pipeline-${CI_PIPELINE_ID}-1
    IMG_DESTINATIONS: apm-library-java-package:pipeline-${CI_PIPELINE_ID}
    IMG_REGISTRIES: agent-qa

onboarding_tests:
  extends: .base_job_onboarding
  stage: single-step-instrumentation-tests
  needs: [ oci-internal-test-ecr-publish ]
  rules:
    #TODO ENABLE THIS BEFORE MERGE- if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "master"
    - if: $CI_PIPELINE_SOURCE == "push"
      when: on_success
  allow_failure: false
  variables:
    TEST_LIBRARY: java
    ONBOARDING_FILTER_ENV: prod
    DD_INSTALLER_LIBRARY_VERSION: pipeline-${CI_PIPELINE_ID}
    SCENARIO: SIMPLE_INSTALLER_AUTO_INJECTION
  parallel:
      matrix:
        - ONBOARDING_FILTER_WEBLOG: [test-app-java, test-app-java-container, test-app-java-container-jdk15, test-app-java-alpine-libgcc, test-app-java-buildpack]         
  script:
    - git clone https://git@github.com/DataDog/system-tests.git system-tests
    - cd system-tests
    - ./build.sh -i runner
    - timeout 2700s ./run.sh $SCENARIO --vm-weblog ${ONBOARDING_FILTER_WEBLOG} --vm-env prod --vm-library ${TEST_LIBRARY} --vm-provider aws --vm-skip-branches ubuntu18_amd64



            