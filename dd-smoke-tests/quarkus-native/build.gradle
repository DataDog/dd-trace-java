import java.util.regex.Pattern

apply from: "$rootDir/gradle/java.gradle"

dependencies {
  testImplementation project(':dd-smoke-tests')
}
// Check 'testJvm' gradle command parameter is GraalVM (e.g., -PtestJvm=graalvm21),
// if not nothing is done
def testJvm = gradle.startParameter.projectProperties.getOrDefault('testJvm', '')
def graalvmMatcher = Pattern.compile("graalvm([0-9]+)").matcher(testJvm?.toLowerCase(Locale.ROOT) ?: '')
def testGraalvmVersion = graalvmMatcher.find() ? Integer.parseInt(graalvmMatcher.group(1)) : -1

if (testGraalvmVersion >= 17) {
  // GraalVM with native-image capability for native compilation
  def graalvmHome = getLazyJavaHomeFor(testGraalvmVersion, true)
  // For GraalVM 21+ we need Java 17+ to run Gradle, for earlier versions use GraalVM itself
  def gradleJavaHome = testGraalvmVersion >= 21 ? getLazyJavaHomeFor(17) : graalvmHome
  // Configure build directory for application
  def appDir = "$projectDir/application"
  def appBuildDir = "$buildDir/application"
  def isWindows = System.getProperty('os.name').toLowerCase().contains('win')
  def gradlewCommand = isWindows ? 'gradlew.bat' : 'gradlew'

  // Define the task that builds the project
  tasks.register('quarkusNativeBuild', Exec) {
    workingDir "$appDir"
    environment += [
      'GRADLE_OPTS' : "-Dorg.gradle.jvmargs='-Xmx512M'",
      'JAVA_HOME'   : gradleJavaHome,
      'GRAALVM_HOME': graalvmHome
    ]
    commandLine(
      "$rootDir/${gradlewCommand}",
      'build',
      '--no-daemon',
      '--max-workers=4',
      "-Dquarkus.native.enabled=true",
      "-Dquarkus.package.jar.enabled=false",
      "-PappBuildDir=$appBuildDir",
      "-PapiJar=${project(':dd-trace-api').tasks.jar.archiveFile.get()}",
      "-Dquarkus.native.additional-build-args=-J-javaagent:${project(':dd-java-agent').tasks.shadowJar.archiveFile.get()}," +
      "-J-Ddatadog.slf4j.simpleLogger.dateTimeFormat=yyyy-MM-dd'T'HH:mm:ss.SSS'Z [dd.trace]',-march=native"
      )
    outputs.cacheIf { true }
    outputs.dir(appBuildDir)
      .withPropertyName('nativeApplication')
    inputs.files(fileTree(appDir) {
      include '**/*'
      exclude '.gradle/**'
    }).withPropertyName('application')
    .withPathSensitivity(PathSensitivity.RELATIVE)
    inputs.file(project(':dd-trace-api').tasks.jar.archiveFile.get()).withPropertyName('apiJar')
    inputs.file(project(':dd-java-agent').tasks.shadowJar.archiveFile.get()).withPropertyName('agentJar')
  }

  tasks.named('quarkusNativeBuild') {
    dependsOn project(':dd-trace-api').tasks.named("jar") // Use dev @Trace annotation
    dependsOn project(':dd-java-agent').tasks.named('shadowJar') // Use dev agent
  }

  tasks.named('compileTestGroovy') {
    dependsOn 'quarkusNativeBuild'
    outputs.upToDateWhen {
      !quarkusNativeBuild.didWork
    }
  }

  tasks.withType(Test).configureEach {
    jvmArgs "-Ddatadog.smoketest.quarkus.native.executable=$appBuildDir/quarkus-native-smoketest--runner"
  }
} else {
  tasks.withType(Test).configureEach {
    enabled = false
  }
}
