package com.datadog.iast.model.json

import com.datadog.iast.model.Evidence
import com.datadog.iast.model.Location
import com.datadog.iast.model.Range
import com.datadog.iast.model.Source
import com.datadog.iast.model.SourceType
import com.datadog.iast.model.Vulnerability
import com.datadog.iast.model.VulnerabilityBatch
import com.datadog.iast.model.VulnerabilityType
import datadog.trace.test.util.DDSpecification
import groovy.json.JsonSlurper

class VulnerabilityEncodingTest extends DDSpecification {

  void 'one vulnerability'() {
    given:
    final slurper = new JsonSlurper()
    final value = new VulnerabilityBatch()
    value.add(new Vulnerability(
      VulnerabilityType.WEAK_HASH,
      Location.forStack(new StackTraceElement("foo", "foo", "foo", 1)),
      new Evidence("MD5")
      ))

    when:
    final result = VulnerabilityEncoding.toJson(value)

    then:
    slurper.parseText(result) == slurper.parseText('''{
      "vulnerabilities": [
        {
          "type": "WEAK_HASH",
          "evidence": {
            "value": "MD5"
          },
          "hash":1042880134,
          "location": {
            "line": 1,
            "path": "foo"
          }
        }
      ]
    }''')
  }

  void 'one vulnerability with one source'() {
    given:
    final slurper = new JsonSlurper()
    final value = new VulnerabilityBatch()
    value.add(new Vulnerability(
      VulnerabilityType.WEAK_HASH,
      Location.forStack(new StackTraceElement("foo", "foo", "foo", 1)),
      new Evidence("BAD", [new Range(0, 1, new Source(SourceType.REQUEST_PATH, "key", "value"))] as Range[])
      ))

    when:
    final result = VulnerabilityEncoding.toJson(value)

    then:
    slurper.parseText(result) == slurper.parseText('''{
      "vulnerabilities": [
        {
          "type": "WEAK_HASH",
          "evidence": {
            "value": "BAD",
            "ranges": [
              {
                "length": 1,
                "start": 0,
                "source": 0
              }
            ]
          },
          "hash":1042880134,
          "location": {
            "line": 1,
            "path": "foo"
          }
        }
      ],
      "sources": [
        {
          "origin": "http.url_details.path",
          "name": "key",
          "value": "value",
        }
      ]
    }''')
  }

  void 'one vulnerability with two sources'() {
    given:
    final slurper = new JsonSlurper()
    final value = new VulnerabilityBatch()
    value.add(new Vulnerability(
      VulnerabilityType.WEAK_HASH,
      Location.forStack(new StackTraceElement("foo", "foo", "foo", 1)),
      new Evidence("BAD", [
        new Range(0, 1, new Source(SourceType.REQUEST_PATH, "key", "value")),
        new Range(1, 1, new Source(SourceType.REQUEST_QUERY_PARAMETER, "key2", "value2"))
      ] as Range[])
      ))

    when:
    final result = VulnerabilityEncoding.toJson(value)

    then:
    slurper.parseText(result) == slurper.parseText('''{
      "vulnerabilities": [
        {
          "type": "WEAK_HASH",
          "evidence": {
            "value": "BAD",
            "ranges": [
              {
                "length": 1,
                "start": 0,
                "source": 0,
              },
              {
                "length": 1,
                "start": 1,
                "source": 1
              }
            ]
          },
          "hash":1042880134,
          "location": {
            "line": 1,
            "path": "foo"
          }
        }
      ],
      "sources": [
        {
          "origin": "http.url_details.path",
          "name": "key",
          "value": "value"
        },
        {
          "origin": "http.url_details.queryString",
          "name": "key2",
          "value": "value2"
        }
      ]
    }''')
  }

  void 'one vulnerability with null source'() {
    given:
    final slurper = new JsonSlurper()
    final value = new VulnerabilityBatch()
    value.add(new Vulnerability(
      VulnerabilityType.WEAK_HASH,
      Location.forStack(new StackTraceElement("foo", "foo", "foo", 1)),
      new Evidence("BAD", [new Range(0, 1, null)] as Range[])
      ))

    when:
    final result = VulnerabilityEncoding.toJson(value)

    then:
    slurper.parseText(result) == slurper.parseText('''{
      "vulnerabilities": [
        {
          "type": "WEAK_HASH",
          "evidence": {
            "value": "BAD",
            "ranges": [
              {
                "length": 1,
                "start": 0
              }
            ]
          },
          "hash":1042880134,
          "location": {
            "line": 1,
            "path": "foo"
          }
        }
      ]
    }''')
  }

  void 'one vulnerability with no source type'() {
    given:
    final slurper = new JsonSlurper()
    final value = new VulnerabilityBatch()
    value.add(new Vulnerability(
      VulnerabilityType.WEAK_HASH,
      Location.forStack(new StackTraceElement("foo", "foo", "foo", 1)),
      new Evidence("BAD", [new Range(0, 1, new Source(SourceType.NONE, "key", "value"))] as Range[])
      ))

    when:
    final result = VulnerabilityEncoding.toJson(value)

    then:
    slurper.parseText(result) == slurper.parseText('''{
      "vulnerabilities": [
        {
          "type": "WEAK_HASH",
          "evidence": {
            "value": "BAD",
            "ranges": [
              {
                "length": 1,
                "start": 0,
                "source": 0
              }
            ]
          },
          "hash":1042880134,
          "location": {
            "line": 1,
            "path": "foo"
          }
        }
      ],
      "sources": [
        {
          "name": "key",
          "value": "value",
        }
      ]
    }''')
  }

  void 'two vulnerabilities with one shared source'() {
    given:
    final slurper = new JsonSlurper()
    final value = new VulnerabilityBatch()
    final source = new Source(SourceType.REQUEST_PATH, "key", "value")
    value.add(new Vulnerability(
      VulnerabilityType.WEAK_HASH,
      Location.forStack(new StackTraceElement("foo", "foo", "foo", 1)),
      new Evidence("BAD1", [new Range(0, 1, source)] as Range[])
      ))
    value.add(new Vulnerability(
      VulnerabilityType.WEAK_HASH,
      Location.forStack(new StackTraceElement("foo", "foo", "foo", 1)),
      new Evidence("BAD2", [new Range(0, 1, source)] as Range[])
      ))

    when:
    final result = VulnerabilityEncoding.toJson(value)

    then:
    slurper.parseText(result) == slurper.parseText('''{
      "vulnerabilities": [
        {
          "evidence": {
            "ranges": [
              {
                "length": 1,
                "source": 0,
                "start": 0
              }
            ],
            "value": "BAD1"
          },
          "hash": 1042880134,
          "location": {
            "line": 1,
            "path": "foo"
          },
          "type": "WEAK_HASH"
        },
        {
          "evidence": {
            "ranges": [
              {
                "length": 1,
                "source": 0,
                "start": 0
              }
            ],
            "value": "BAD2"
          },
          "hash": 1042880134,
          "location": {
            "line": 1,
            "path": "foo"
          },
          "type": "WEAK_HASH"
        }
      ],
      "sources": [
        {
          "name": "key",
          "origin": "http.url_details.path",
          "value": "value"
        }
      ]
    }''')
  }

  void 'two vulnerability with no shared sources'() {
    given:
    final slurper = new JsonSlurper()
    final value = new VulnerabilityBatch()
    value.add(new Vulnerability(
      VulnerabilityType.WEAK_HASH,
      Location.forStack(new StackTraceElement("foo", "foo", "foo", 1)),
      new Evidence("BAD", [new Range(0, 1, new Source(SourceType.REQUEST_PATH, "key1", "value"))] as Range[])
      ))
    value.add(new Vulnerability(
      VulnerabilityType.WEAK_HASH,
      Location.forStack(new StackTraceElement("foo", "foo", "foo", 1)),
      new Evidence("BAD", [new Range(0, 1, new Source(SourceType.REQUEST_PATH, "key2", "value"))] as Range[])
      ))

    when:
    final result = VulnerabilityEncoding.toJson(value)

    then:
    slurper.parseText(result) == slurper.parseText('''{
      "vulnerabilities": [
        {
          "evidence": {
            "ranges": [
              {
                "length": 1,
                "source": 0,
                "start": 0
              }
            ],
            "value": "BAD"
          },
          "hash": 1042880134,
          "location": {
            "line": 1,
            "path": "foo"
          },
          "type": "WEAK_HASH"
        },
        {
          "evidence": {
            "ranges": [
              {
                "length": 1,
                "source": 1,
                "start": 0
              }
            ],
            "value": "BAD"
          },
          "hash": 1042880134,
          "location": {
            "line": 1,
            "path": "foo"
          },
          "type": "WEAK_HASH"
        }
      ],
      "sources": [
        {
          "name": "key1",
          "origin": "http.url_details.path",
          "value": "value"
        },
        {
          "name": "key2",
          "origin": "http.url_details.path",
          "value": "value"
        }
      ]
    }''')
  }
}
