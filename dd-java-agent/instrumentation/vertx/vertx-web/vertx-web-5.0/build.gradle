apply from: "$rootDir/gradle/java.gradle"

tracerJava {
  addSourceSetFor(JavaVersion.VERSION_11)
}

testJvmConstraints {
  minJavaVersion = JavaVersion.VERSION_11
}

muzzle {
  pass {
    group = 'io.vertx'
    module = 'vertx-web'
    versions = '[5.0.0.CR1,)'
    javaVersion = '11'
    includeSnapshots = true // to remove when vert.x 5 is finally released
  }
}

addTestSuiteForDir('latestDepTest', 'test')
addTestSuiteExtendingForDir('latestDepForkedTest', 'latestDepTest', 'test')

configurations {
  testArtifacts
}

// Create test artifacts so vertx-rx can reuse the server test instrumentation and base class
artifacts {
  testArtifacts testJar
}

final vertxVersion = '5.0.0.CR3'

dependencies {
  api project(':dd-java-agent:instrumentation:netty:netty-common')

  compileOnly group: 'io.vertx', name: 'vertx-web', version: vertxVersion

  testImplementation project(':dd-java-agent:instrumentation:netty:netty-4.1')
  testImplementation project(':dd-java-agent:instrumentation:vertx:vertx-web:vertx-web-4.0')

  testImplementation project(':dd-java-agent:instrumentation:trace-annotation')
  testImplementation project(':dd-java-agent:agent-iast:iast-test-fixtures')
  testRuntimeOnly project(':dd-java-agent:instrumentation:iast-instrumenter')

  testImplementation group: 'io.vertx', name: 'vertx-web', version: vertxVersion
  testImplementation group: 'io.vertx', name: 'vertx-web-client', version: vertxVersion

  testImplementation project(':dd-java-agent:appsec:appsec-test-fixtures')

  testRuntimeOnly project(':dd-java-agent:instrumentation:jackson-core:jackson-core-common')
  testRuntimeOnly project(':dd-java-agent:instrumentation:netty:netty-buffer-4.0')

  latestDepTestImplementation group: 'io.vertx', name: 'vertx-web', version: '+'
  latestDepTestImplementation group: 'io.vertx', name: 'vertx-web-client', version: '+'
}

tasks.named("compileJava", JavaCompile) {
  configureCompiler(it, 11, JavaVersion.VERSION_1_8)
}

