ext {
  jetty11TestMinJavaVersionForTests = JavaVersion.VERSION_11
}

muzzle {
  pass {
    group = "com.linecorp.armeria"
    module = "armeria-jetty11"
    versions = "[1.24.0,)"
  }
  pass {
    group = "com.linecorp.armeria"
    module = "armeria-jetty9"
    versions = "[1.24.0,)"
  }
}

apply from: "$rootDir/gradle/java.gradle"
apply from: "$rootDir/gradle/configure_tests.gradle"

addTestSuiteForDir('latestDepTest', 'test')

addTestSuiteForDir("jetty9Test", "test/jetty9")
addTestSuiteForDir("jetty11Test", "test/jetty11")
addTestSuiteExtendingForDir("jetty9LatestDepTest", "latestDepTest", "test/jetty9")
addTestSuiteExtendingForDir("jetty11LatestDepTest", "latestDepTest", "test/jetty11")

["compileJetty11TestGroovy", "compileJetty11LatestDepTestGroovy"].each { name ->
  tasks.named(name, GroovyCompile) {
    configureCompiler(it, 11)
  }
}

["jetty11Test", "jetty11LatestDepTest"].each { name ->
  tasks.named(name, Test) {
    javaLauncher = getJavaLauncherFor(11)
  }
}

dependencies {
  compileOnly group: 'com.linecorp.armeria', name: 'armeria-jetty9', version: '1.24.0'
  jetty11TestImplementation group: 'com.linecorp.armeria', name: 'armeria-jetty11', version: '1.24.0',   {
    exclude group: 'org.slf4j', module: 'slf4j-api'
  }
  jetty11TestImplementation "org.eclipse.jetty:jetty-server:11.0.0",  {
    exclude group: 'org.slf4j', module: 'slf4j-api'
  }
  jetty11TestImplementation "org.eclipse.jetty:jetty-servlet:11.0.0",  {
    exclude group: 'org.slf4j', module: 'slf4j-api'
  }

  jetty11LatestDepTestImplementation group: 'com.linecorp.armeria', name: 'armeria-jetty11', version: '+',   {
    exclude group: 'org.slf4j', module: 'slf4j-api'
  }
  jetty11LatestDepTestImplementation "org.eclipse.jetty:jetty-server:11.+",  {
    exclude group: 'org.slf4j', module: 'slf4j-api'
  }
  jetty11LatestDepTestImplementation "org.eclipse.jetty:jetty-servlet:11.+",  {
    exclude group: 'org.slf4j', module: 'slf4j-api'
  }

  jetty9TestImplementation group: 'com.linecorp.armeria', name: 'armeria-jetty9', version: '1.24.0',   {
    exclude group: 'org.slf4j', module: 'slf4j-api'
  }
  jetty9TestImplementation "org.eclipse.jetty:jetty-server:9.4.48.v20220622",  {
    exclude group: 'org.slf4j', module: 'slf4j-api'
  }
  jetty9TestImplementation "org.eclipse.jetty:jetty-servlet:9.4.48.v20220622",  {
    exclude group: 'org.slf4j', module: 'slf4j-api'
  }
  jetty9LatestDepTestImplementation group: 'com.linecorp.armeria', name: 'armeria-jetty9', version: '+',   {
    exclude group: 'org.slf4j', module: 'slf4j-api'
  }
  jetty9LatestDepTestImplementation "org.eclipse.jetty:jetty-server:9.+",  {
    exclude group: 'org.slf4j', module: 'slf4j-api'
  }
  jetty9LatestDepTestImplementation "org.eclipse.jetty:jetty-servlet:9.+",  {
    exclude group: 'org.slf4j', module: 'slf4j-api'
  }
  testImplementation testFixtures(project(':dd-java-agent:instrumentation:servlet:javax-servlet:javax-servlet-3.0'))
  testImplementation testFixtures(project(':dd-java-agent:instrumentation:jetty:jetty-server:jetty-server-9.0'))
  testImplementation testFixtures(project(':dd-java-agent:instrumentation:servlet:jakarta-servlet-5.0'))
  testImplementation testFixtures(project(':dd-java-agent:instrumentation:jetty:jetty-server:jetty-server-11.0'))

  testImplementation(project(':dd-java-agent:instrumentation-testing')) {
    exclude group: 'org.eclipse.jetty', module: 'jetty-server'
  }
  // always mix everything up
  testRuntimeOnly project(':dd-java-agent:instrumentation:jetty:jetty-server:jetty-server-11.0')
  testRuntimeOnly project(':dd-java-agent:instrumentation:jetty:jetty-server:jetty-server-9.0')
  testRuntimeOnly(project(':dd-java-agent:instrumentation:jetty:jetty-util-9.4.31'))
  testRuntimeOnly project(':dd-java-agent:instrumentation:jetty:jetty-appsec:jetty-appsec-9.3')
  testRuntimeOnly project(':dd-java-agent:instrumentation:servlet:jakarta-servlet-5.0')
  testRuntimeOnly project(':dd-java-agent:instrumentation:servlet:javax-servlet:javax-servlet-3.0')
}
