import com.google.common.base.Strings
import com.openai.client.OpenAIClient
import com.openai.client.okhttp.OpenAIOkHttpClient
import com.openai.core.ClientOptions
import com.openai.credential.BearerTokenCredential
import com.openai.models.ChatModel
import com.openai.models.chat.completions.ChatCompletionCreateParams
import com.openai.models.completions.CompletionCreateParams
import com.openai.models.embeddings.EmbeddingCreateParams
import com.openai.models.embeddings.EmbeddingModel
import datadog.trace.agent.test.server.http.TestHttpServer
import datadog.trace.llmobs.LlmObsSpecification
import spock.lang.AutoCleanup
import spock.lang.Shared


abstract class OpenAiTest extends LlmObsSpecification {

  // openai token - will use real openai backend
  // null - will use mockOpenAiBackend
  String openAiToken() {
    return null
  }

  static String API_VERSION = "v1"

  @AutoCleanup
  @Shared
  OpenAIClient openAiClient

  @Shared
  def openAiBaseApi

  @AutoCleanup
  @Shared
  def mockOpenAiBackend = TestHttpServer.httpServer {
    handlers {
      prefix("/$API_VERSION/chat/completions") {
        if ('{"messages":[{"content":"","role":"system"},{"content":"","role":"user"}],"model":"gpt-4o-mini"}' == request.text) {
          response
              .status(200)
              .addHeader("openai-organization", "datadog-staging")
              .addHeader("x-ratelimit-limit-requests", "30000")
              .addHeader("x-ratelimit-limit-tokens", "150000000")
              .addHeader("x-ratelimit-remaining-requests", "29999")
              .addHeader("x-ratelimit-remaining-tokens", "149999997")
              .send("""
{
  "id": "chatcmpl-CaZMmD0wsnDrkBEND9i5MvH6sD8BJ",
  "object": "chat.completion",
  "created": 1762831792,
  "model": "gpt-4o-mini-2024-07-18",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Hello! How can I assist you today?",
        "refusal": null,
        "annotations": []
      },
      "logprobs": null,
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 11,
    "completion_tokens": 9,
    "total_tokens": 20,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0,
      "audio_tokens": 0,
      "accepted_prediction_tokens": 0,
      "rejected_prediction_tokens": 0
    }
  },
  "service_tier": "default",
  "system_fingerprint": "fp_51db84afab"
}
""")
        } else if ('{"messages":[{"content":"","role":"system"},{"content":"","role":"user"}],"model":"gpt-4o-mini","stream":true}' == request.text) {
          response
              .status(200)
              .addHeader("openai-organization", "datadog-staging")
              .addHeader("x-ratelimit-limit-requests", "30000")
              .addHeader("x-ratelimit-limit-tokens", "150000000")
              .addHeader("x-ratelimit-remaining-requests", "29999")
              .addHeader("x-ratelimit-remaining-tokens", "149999997")
              .addHeader("x-ratelimit-reset-requests", "2ms")
              .addHeader("x-ratelimit-reset-tokens", "0s")
              .send("""data: {"id":"chatcmpl-CaaaTDBCTlHEMLpwRDECbyJI1Uxs7","object":"chat.completion.chunk","created":1762836485,"model":"gpt-4o-mini-2024-07-18","service_tier":"default","system_fingerprint":"fp_51db84afab","choices":[{"index":0,"delta":{"role":"assistant","content":"","refusal":null},"logprobs":null,"finish_reason":null}],"obfuscation":"1md8PY"}

data: {"id":"chatcmpl-CaaaTDBCTlHEMLpwRDECbyJI1Uxs7","object":"chat.completion.chunk","created":1762836485,"model":"gpt-4o-mini-2024-07-18","service_tier":"default","system_fingerprint":"fp_51db84afab","choices":[{"index":0,"delta":{"content":"Hello"},"logprobs":null,"finish_reason":null}],"obfuscation":"WPa"}

data: {"id":"chatcmpl-CaaaTDBCTlHEMLpwRDECbyJI1Uxs7","object":"chat.completion.chunk","created":1762836485,"model":"gpt-4o-mini-2024-07-18","service_tier":"default","system_fingerprint":"fp_51db84afab","choices":[{"index":0,"delta":{"content":"!"},"logprobs":null,"finish_reason":null}],"obfuscation":"5TMzy5W"}

data: {"id":"chatcmpl-CaaaTDBCTlHEMLpwRDECbyJI1Uxs7","object":"chat.completion.chunk","created":1762836485,"model":"gpt-4o-mini-2024-07-18","service_tier":"default","system_fingerprint":"fp_51db84afab","choices":[{"index":0,"delta":{"content":" How"},"logprobs":null,"finish_reason":null}],"obfuscation":"LAvv"}

data: {"id":"chatcmpl-CaaaTDBCTlHEMLpwRDECbyJI1Uxs7","object":"chat.completion.chunk","created":1762836485,"model":"gpt-4o-mini-2024-07-18","service_tier":"default","system_fingerprint":"fp_51db84afab","choices":[{"index":0,"delta":{"content":" can"},"logprobs":null,"finish_reason":null}],"obfuscation":"u87W"}

data: {"id":"chatcmpl-CaaaTDBCTlHEMLpwRDECbyJI1Uxs7","object":"chat.completion.chunk","created":1762836485,"model":"gpt-4o-mini-2024-07-18","service_tier":"default","system_fingerprint":"fp_51db84afab","choices":[{"index":0,"delta":{"content":" I"},"logprobs":null,"finish_reason":null}],"obfuscation":"HJgkk6"}

data: {"id":"chatcmpl-CaaaTDBCTlHEMLpwRDECbyJI1Uxs7","object":"chat.completion.chunk","created":1762836485,"model":"gpt-4o-mini-2024-07-18","service_tier":"default","system_fingerprint":"fp_51db84afab","choices":[{"index":0,"delta":{"content":" assist"},"logprobs":null,"finish_reason":null}],"obfuscation":"9"}

data: {"id":"chatcmpl-CaaaTDBCTlHEMLpwRDECbyJI1Uxs7","object":"chat.completion.chunk","created":1762836485,"model":"gpt-4o-mini-2024-07-18","service_tier":"default","system_fingerprint":"fp_51db84afab","choices":[{"index":0,"delta":{"content":" you"},"logprobs":null,"finish_reason":null}],"obfuscation":"zPew"}

data: {"id":"chatcmpl-CaaaTDBCTlHEMLpwRDECbyJI1Uxs7","object":"chat.completion.chunk","created":1762836485,"model":"gpt-4o-mini-2024-07-18","service_tier":"default","system_fingerprint":"fp_51db84afab","choices":[{"index":0,"delta":{"content":" today"},"logprobs":null,"finish_reason":null}],"obfuscation":"N7"}

data: {"id":"chatcmpl-CaaaTDBCTlHEMLpwRDECbyJI1Uxs7","object":"chat.completion.chunk","created":1762836485,"model":"gpt-4o-mini-2024-07-18","service_tier":"default","system_fingerprint":"fp_51db84afab","choices":[{"index":0,"delta":{"content":"?"},"logprobs":null,"finish_reason":null}],"obfuscation":"6yvsDdL"}

data: {"id":"chatcmpl-CaaaTDBCTlHEMLpwRDECbyJI1Uxs7","object":"chat.completion.chunk","created":1762836485,"model":"gpt-4o-mini-2024-07-18","service_tier":"default","system_fingerprint":"fp_51db84afab","choices":[{"index":0,"delta":{},"logprobs":null,"finish_reason":"stop"}],"obfuscation":"5e"}

data: [DONE]
""")
        } else {
          response.status(500).send("Unexpected Request!")
        }
      }
      prefix("/$API_VERSION/completions") {
        if ('{"model":"gpt-3.5-turbo-instruct","prompt":"Tell me a story about building the best SDK!","stream":true}' == request.text) {
          response
              .addHeader("openai-organization", "datadog-staging")
              .addHeader("x-ratelimit-limit-requests", "3500")
              .addHeader("x-ratelimit-remaining-requests", "3499")
              .addHeader("x-ratelimit-limit-tokens", "90000")
              .addHeader("x-ratelimit-remaining-tokens", "89994")
              .status(200)
              .send("""data: {"id":"cmpl-CYhd8HZjl8iY5SA1poPy3TqMdspV0","object":"text_completion","created":1762386902,"choices":[{"text":"\\n\\n","index":0,"logprobs":null,"finish_reason":null}],"model":"gpt-3.5-turbo-instruct:20230824-v2"}

data: {"id":"cmpl-CYhd8HZjl8iY5SA1poPy3TqMdspV0","object":"text_completion","created":1762386902,"choices":[{"text":"Once","index":0,"logprobs":null,"finish_reason":null}],"model":"gpt-3.5-turbo-instruct:20230824-v2"}

data: {"id":"cmpl-CYhd8HZjl8iY5SA1poPy3TqMdspV0","object":"text_completion","created":1762386902,"choices":[{"text":" upon","index":0,"logprobs":null,"finish_reason":null}],"model":"gpt-3.5-turbo-instruct:20230824-v2"}

data: {"id":"cmpl-CYhd8HZjl8iY5SA1poPy3TqMdspV0","object":"text_completion","created":1762386902,"choices":[{"text":" a","index":0,"logprobs":null,"finish_reason":null}],"model":"gpt-3.5-turbo-instruct:20230824-v2"}

data: {"id":"cmpl-CYhd8HZjl8iY5SA1poPy3TqMdspV0","object":"text_completion","created":1762386902,"choices":[{"text":" time","index":0,"logprobs":null,"finish_reason":null}],"model":"gpt-3.5-turbo-instruct:20230824-v2"}

data: {"id":"cmpl-CYhd8HZjl8iY5SA1poPy3TqMdspV0","object":"text_completion","created":1762386902,"choices":[{"text":",","index":0,"logprobs":null,"finish_reason":null}],"model":"gpt-3.5-turbo-instruct:20230824-v2"}

data: {"id":"cmpl-CYhd8HZjl8iY5SA1poPy3TqMdspV0","object":"text_completion","created":1762386902,"choices":[{"text":" there","index":0,"logprobs":null,"finish_reason":null}],"model":"gpt-3.5-turbo-instruct:20230824-v2"}

data: {"id":"cmpl-CYhd8HZjl8iY5SA1poPy3TqMdspV0","object":"text_completion","created":1762386902,"choices":[{"text":" was a company called","index":0,"logprobs":null,"finish_reason":null}],"model":"gpt-3.5-turbo-instruct:20230824-v2"}

data: {"id":"cmpl-CYhd8HZjl8iY5SA1poPy3TqMdspV0","object":"text_completion","created":1762386902,"choices":[{"text":" \\"","index":0,"logprobs":null,"finish_reason":null}],"model":"gpt-3.5-turbo-instruct:20230824-v2"}

data: {"id":"cmpl-CYhd8HZjl8iY5SA1poPy3TqMdspV0","object":"text_completion","created":1762386902,"choices":[{"text":"Tech","index":0,"logprobs":null,"finish_reason":null}],"model":"gpt-3.5-turbo-instruct:20230824-v2"}

data: {"id":"cmpl-CYhd8HZjl8iY5SA1poPy3TqMdspV0","object":"text_completion","created":1762386902,"choices":[{"text":" Innovations\\"","index":0,"logprobs":null,"finish_reason":"length"}],"model":"gpt-3.5-turbo-instruct:20230824-v2"}

data: {"id":"cmpl-CYhd8HZjl8iY5SA1poPy3TqMdspV0","object":"text_completion","created":1762386902,"choices":[{"text":"","index":0,"logprobs":null,"finish_reason":"length"}],"model":"gpt-3.5-turbo-instruct:20230824-v2"}

data: [DONE]

""")
        } else if ('{"model":"gpt-3.5-turbo-instruct","prompt":"Tell me a story about building the best SDK!"}' == request.text) {
          response
              .addHeader("openai-organization", "datadog-staging")
              .addHeader("x-ratelimit-limit-requests", "3500")
              .addHeader("x-ratelimit-remaining-requests", "3499")
              .addHeader("x-ratelimit-limit-tokens", "90000")
              .addHeader("x-ratelimit-remaining-tokens", "89994")
              .status(200)
              .send("""{
  "id": "cmpl-CYhd78PVSfxem8cdTSGsgZnSU9e2U",
  "object": "text_completion",
  "created": 1762386901,
  "model": "gpt-3.5-turbo-instruct:20230824-v2",
  "choices": [
    {
      "text": "\\n\\nOnce upon a time, in a busy and bustling tech industry, there was",
      "index": 0,
      "logprobs": null,
      "finish_reason": "length"
    }
  ],
  "usage": {
    "prompt_tokens": 10,
    "completion_tokens": 16,
    "total_tokens": 26
  }
}
"""
          )
        } else {
          response.status(500).send("Unexpected Request!")
        }
      }
      prefix("/$API_VERSION/embeddings") {
        if ('{"input":"hello world","model":"text-embedding-ada-002"}' == request.text) {
          response
              .status(200)
              .addHeader("openai-model", "text-embedding-ada-002-v2")
              .addHeader("openai-organization", "datadog-staging")
              .addHeader("x-ratelimit-limit-requests", "10000")
              .addHeader("x-ratelimit-limit-tokens", "10000000")
              .addHeader("x-ratelimit-remaining-requests", "9999")
              .addHeader("x-ratelimit-remaining-tokens", "9999998")
              .send("""{
  "object": "list",
  "data": [
    {
      "object": "embedding",
      "index": 0,
      "embedding": [
        -0.016099498,
        0.001368687,
        -0.019484723,
        -0.033694793,
        -0.026005873,
        0.0076758,
        -0.024890585,
        -0.0003144946,
        -0.013002937,
        -0.021689055,
        0.026242051,
        0.008115354,
        -0.03175288,
        -0.003516435,
        0.004720289,
        0.012852045,
        0.017752748,
        -0.026320778,
        0.017175423,
        0.009060068,
        -0.006550672,
        0.006065194,
        0.0061603216,
        -0.009073189,
        -0.014774275,
        -0.010162234,
        0.01855313,
        -0.01573211,
        0.018002046,
        -0.03697505,
        0.0016401282,
        -0.003006355,
        -0.018868035,
        -0.015614021,
        0.011835165,
        -0.010017903,
        0.000110093606,
        -0.018723704,
        0.024615044,
        -0.018500647,
        0.008541788,
        -0.0022289343,
        0.018828671,
        -0.021308545,
        -0.03799849,
        0.0056945253,
        -0.00021157654,
        -0.025021795,
        -0.0015843639,
        0.033563584,
        0.030283326,
        -0.005825735,
        -0.022331985,
        0.00857459,
        -0.018185742,
        0.02251568,
        -0.029574791,
        0.021203578,
        0.026018994,
        -0.020665616,
        0.0016614499,
        0.0070853536,
        -0.019366633,
        0.014603701,
        0.010418095,
        0.007203443,
        0.011330006,
        0.0034508298,
        -0.012084465,
        0.002620925,
        0.02225326,
        0.014341281,
        -0.016978607,
        -0.004631722,
        0.019104213,
        -0.002263377,
        -0.024851222,
        -0.0040511168,
        0.0023650648,
        0.0031785686,
        0.03776231,
        -0.03456078,
        -0.010680514,
        0.0052156076,
        0.018080773,
        0.009558667,
        -0.008194081,
        0.025244853,
        -0.013298159,
        -0.016283194,
        0.005153283,
        0.0020157176,
        0.0076692393,
        0.0066490797,
        -0.0123272035,
        0.0056125186,
        -0.008738603,
        0.018316953,
        0.00030116853,
        -0.031201798,
        -0.019812748,
        -0.0130554205,
        -0.015049816,
        -0.009919495,
        -0.01752969,
        -0.011480898,
        0.0068294937,
        0.0032638551,
        0.021531602,
        0.006065194,
        -0.015535294,
        0.020324469,
        -0.008961661,
        -0.0317004,
        -0.006796691,
        -0.003365543,
        -0.008259686,
        -0.0026816097,
        -0.01419695,
        -0.022069564,
        0.008036628,
        0.022791222,
        0.023919629,
        -0.018776188,
        0.008784527,
        0.0041626454,
        -0.048127923,
        -0.011218477,
        -0.006166882,
        -0.017700264,
        0.03723747,
        0.0070066275,
        0.026150204,
        -0.012438732,
        -0.029102435,
        0.016493129,
        -0.021912113,
        0.017700264,
        -0.020376952,
        -0.021124851,
        -0.0046120407,
        0.026123961,
        0.015692746,
        -0.006255449,
        -0.0040609576,
        -0.0032031704,
        0.015915804,
        0.0032835368,
        0.0010988859,
        -0.009184718,
        -0.0027603358,
        0.004848219,
        0.004707168,
        0.009906374,
        0.020153895,
        0.016506251,
        -0.004533314,
        0.02622893,
        0.0057043657,
        -0.009348731,
        -0.0002047085,
        0.0028521828,
        0.0072296853,
        -0.034088425,
        0.005090958,
        0.035321802,
        0.02226638,
        0.010221279,
        0.005832296,
        -0.026438866,
        -0.009138795,
        0.013330962,
        -0.037053775,
        0.015181026,
        -0.0010652633,
        0.0067376466,
        0.00934217,
        0.033458617,
        -0.007944781,
        -0.01228784,
        -0.02763288,
        0.022778101,
        0.009676756,
        0.029732244,
        -0.0043036966,
        -0.0025602402,
        0.0076692393,
        0.0011185674,
        0.005412423,
        -0.007216564,
        0.0115137,
        0.034954414,
        0.021033004,
        0.014091982,
        -0.6885914,
        -0.010024464,
        0.011874529,
        0.01062147,
        0.008948539,
        0.019970201,
        0.008948539,
        0.018474404,
        -0.007767647,
        0.024733134,
        -0.0018271029,
        0.015902683,
        0.0022846987,
        -0.01304886,
        -0.008135036,
        -0.00921752,
        0.011710515,
        -0.02073122,
        -0.019497843,
        0.025809057,
        -0.008725482,
        0.02674065,
        -0.023368547,
        -0.006157041,
        -0.0010906853,
        0.0044808304,
        0.0014744753,
        -0.01586332,
        -0.014091982,
        0.04219722,
        -0.02073122,
        0.009637393,
        0.011579305,
        0.0017172142,
        0.058729712,
        0.015928926,
        -0.016060134,
        0.009237202,
        0.012655229,
        0.042170975,
        -0.01407886,
        -0.017726505,
        0.004539875,
        -0.008732042,
        0.0024979152,
        0.01432816,
        0.008810769,
        -0.009971979,
        -0.0052123275,
        -0.0051860856,
        0.03198906,
        -0.005350098,
        0.017555932,
        0.010208158,
        -0.008686119,
        -0.010181916,
        0.022331985,
        -0.0076167556,
        -0.0033688233,
        0.014603701,
        -0.002752135,
        0.015627142,
        -0.0013211232,
        0.00614064,
        -0.013619624,
        0.013160389,
        -0.030020906,
        0.0045693973,
        0.0041692057,
        -0.0056846845,
        0.0027176924,
        0.0054452256,
        -0.025139885,
        -0.012136948,
        0.014748033,
        0.033930972,
        0.015666505,
        -0.012615866,
        -0.0054550664,
        0.027790332,
        0.019038608,
        0.0069016595,
        -0.018697461,
        -0.013101344,
        0.01855313,
        -0.015784593,
        -0.030650716,
        -0.0025356382,
        -0.006088156,
        0.0010529623,
        0.036633905,
        0.009119113,
        -0.018894278,
        -0.027580395,
        0.028918741,
        0.0046415627,
        -0.006002869,
        0.0054058624,
        0.021046124,
        -0.007137838,
        -0.0034344285,
        0.009663635,
        -0.007866055,
        0.0076823602,
        0.03736868,
        -0.004270894,
        -0.0038575814,
        0.025992751,
        0.017241027,
        -0.017739626,
        0.0073215324,
        -0.001330144,
        -0.02915492,
        0.0143937655,
        0.005783092,
        -0.030047148,
        0.0019041889,
        0.021557845,
        0.025139885,
        -0.00946682,
        0.032067787,
        -0.015377842,
        0.02697683,
        0.0014998972,
        -0.001035741,
        0.018618735,
        -0.0060291113,
        -0.008600832,
        -0.009263444,
        -0.017647779,
        0.017752748,
        -0.0070591117,
        0.014879243,
        -0.014000135,
        0.010942935,
        -0.010864209,
        -0.005346818,
        -0.015036696,
        0.0033032182,
        0.0066064363,
        -0.008016947,
        -0.0049859895,
        -0.008043189,
        0.0009816167,
        0.015495931,
        -0.025533516,
        -0.022909312,
        -0.004923665,
        0.0030243965,
        -0.00012321463,
        0.0040511168,
        -0.010536184,
        -0.03708002,
        0.025625363,
        -0.008003825,
        -0.00422497,
        0.0062751304,
        -0.025625363,
        -0.014813638,
        -0.029496066,
        0.0035623584,
        0.0104837,
        -0.016401282,
        0.012071343,
        -0.003595161,
        -0.032697596,
        -0.022764979,
        0.020350711,
        0.001573703,
        -0.037526134,
        0.0032720556,
        0.003519715,
        -0.011061025,
        0.0034639507,
        -0.0011538302,
        0.023893388,
        -0.01304886,
        -0.00613736,
        0.0040806388,
        -0.012983255,
        0.016283194,
        -0.007905418,
        -0.019747144,
        0.0136327455,
        0.009926056,
        0.00073846773,
        -0.0002583202,
        0.031884093,
        -0.016440645,
        0.0022584565,
        0.011179114,
        0.006294812,
        -0.014131345,
        -0.0028161001,
        0.004110161,
        -0.008863253,
        0.010063827,
        -0.0015195787,
        0.016991729,
        0.013698351,
        0.04833786,
        0.006665481,
        0.029968422,
        -0.024155809,
        -0.006642519,
        -0.025927147,
        -0.006088156,
        -0.017870836,
        0.015889563,
        0.01342937,
        0.0043332186,
        -0.01830383,
        0.00396911,
        0.016335677,
        0.009427457,
        0.034377087,
        -0.0041495245,
        -0.0034869125,
        -0.017345997,
        0.0018910678,
        0.009545546,
        0.006157041,
        -0.011054464,
        -0.009348731,
        0.01599453,
        0.025769694,
        0.009125673,
        0.042722058,
        0.008266246,
        -0.010805164,
        -0.028761288,
        0.008909176,
        0.012766758,
        0.001266999,
        -0.002506116,
        0.008036628,
        0.01035249,
        -0.03083441,
        0.030125875,
        -0.007583953,
        -0.006708124,
        0.009060068,
        0.03364231,
        -0.025244853,
        -0.0054616267,
        0.03175288,
        0.01739848,
        -0.00728873,
        0.0027800172,
        0.040727664,
        -0.013088223,
        -0.00077988097,
        -0.014524975,
        0.0072493665,
        0.011828604,
        -0.035006896,
        0.0036312437,
        -0.003262215,
        0.037552375,
        0.02200396,
        0.02431326,
        0.0074265003,
        0.0041003204,
        -0.018920518,
        -0.0005383721,
        -0.020665616,
        0.011953254,
        -0.008902616,
        -0.000831545,
        0.00008913071,
        -0.008856692,
        0.0028964663,
        0.014892364,
        -0.022948673,
        0.012064783,
        -0.0040839193,
        -0.00004866568,
        0.0033721037,
        0.009473381,
        0.0038838235,
        -0.021794023,
        -0.023394788,
        0.003057199,
        0.008686119,
        0.0005654342,
        -0.030283326,
        -0.03770983,
        0.001841864,
        0.0017943003,
        0.0065801945,
        -0.0153516,
        0.0028718645,
        0.026766893,
        -0.02532358,
        0.008686119,
        0.0066622007,
        0.023578484,
        -0.0051106396,
        -0.002060001,
        -0.01228128,
        0.015299116,
        -0.0011070865,
        -0.010956056,
        -0.024195172,
        0.009991661,
        0.00030362874,
        -0.009309367,
        -0.02355224,
        -0.00087582844,
        0.0021206858,
        -0.023066763,
        0.0006995147,
        -0.0143937655,
        -0.0114743365,
        0.009755483,
        0.00071960624,
        -0.008791087,
        0.00971612,
        0.029706001,
        -0.007898858,
        -0.00729529,
        -0.021413514,
        -0.024287019,
        -0.014957969,
        0.048679005,
        0.011677713,
        -0.00447755,
        0.004762932,
        -0.0061865635,
        -0.0069935066,
        -0.04594983,
        -0.022988036,
        0.005192646,
        -0.007872615,
        0.0031785686,
        -0.008791087,
        -0.00319661,
        0.017949563,
        0.02660944,
        0.0056322003,
        0.015627142,
        -0.02330294,
        -0.010195036,
        0.009420896,
        -0.002763616,
        -0.0055403532,
        -0.004444747,
        0.016033893,
        0.021321667,
        -0.00191895,
        0.0067573283,
        0.0144856125,
        -0.005665003,
        -0.0073871375,
        0.0032031704,
        0.0032540143,
        0.020757463,
        0.012432172,
        0.015823957,
        0.032960016,
        0.01470867,
        0.02174154,
        0.008312169,
        -0.018146379,
        0.006334175,
        0.009552106,
        -0.0048121363,
        -0.008390896,
        0.011874529,
        0.01165147,
        -0.011566184,
        0.014262555,
        0.0037952566,
        -0.03621403,
        0.034114666,
        -0.00021096149,
        -0.006488347,
        -0.016099498,
        -0.015810836,
        0.016073257,
        -0.021203578,
        -0.013449051,
        -0.011480898,
        -0.004448028,
        -0.00027164622,
        -0.014656185,
        0.0073936977,
        -0.00074051786,
        -0.0278953,
        -0.02494307,
        -0.02904995,
        0.02200396,
        -0.019091092,
        0.0021912113,
        -0.014616823,
        -0.023486637,
        -0.016991729,
        -0.0021682496,
        0.021557845,
        0.00858115,
        -0.01548281,
        0.003568919,
        0.0109888585,
        0.013514657,
        -0.009945737,
        -0.034140907,
        0.0011530102,
        -0.0032540143,
        0.008476183,
        0.0076692393,
        0.0080103865,
        0.0058913403,
        -0.0105624255,
        0.025638483,
        0.012674911,
        0.010090069,
        0.0128126815,
        -0.013593382,
        0.02713428,
        0.00082703464,
        0.006622838,
        -0.005901181,
        -0.008240004,
        0.0024864343,
        -0.0012104146,
        -0.011612108,
        -0.009611151,
        -0.0004108521,
        0.0030539187,
        0.009827648,
        0.025349822,
        0.026399503,
        -0.022686252,
        -0.014866122,
        0.030178359,
        -0.027055554,
        0.023329183,
        -0.008148157,
        0.000039055554,
        0.02431326,
        0.010923253,
        0.039546773,
        0.0016450486,
        -0.017293511,
        -0.008128475,
        -0.03159543,
        -0.0016302874,
        0.02073122,
        0.03143798,
        0.005999589,
        0.0066818823,
        -0.018605614,
        -0.003975671,
        -0.01163835,
        -0.014498733,
        0.013409688,
        -0.0053697797,
        -0.018854914,
        -0.01995708,
        -0.013088223,
        -0.014183829,
        0.0057863723,
        -0.0036246832,
        -0.018093895,
        -0.020678736,
        -0.011061025,
        0.007347774,
        -0.0048055756,
        -0.039231867,
        -0.039756708,
        -0.011192235,
        0.00020501603,
        -0.00856147,
        0.008226883,
        -0.00065523124,
        -0.0006970545,
        -0.016348798,
        -0.015285995,
        0.006091436,
        -0.010798604,
        0.0050089513,
        -0.013081662,
        0.032933775,
        0.012825803,
        0.033721037,
        0.00818752,
        0.010273763,
        0.012648669,
        -0.007203443,
        -0.013921408,
        -0.00421841,
        0.0007536389,
        -0.016020773,
        0.014472491,
        0.03786728,
        0.028210204,
        -0.0072624874,
        0.012622426,
        -0.003673887,
        -0.0015154785,
        -0.0070591117,
        0.008863253,
        -0.024063962,
        -0.017687142,
        -0.023053642,
        0.0032786164,
        -0.0028439823,
        -0.0017647779,
        0.013895166,
        0.0065703536,
        0.01599453,
        0.020783704,
        0.017634658,
        -0.0039231866,
        0.030676957,
        -0.022974916,
        0.01714918,
        -0.0015450007,
        0.012425611,
        -0.004205289,
        -0.0022453356,
        -0.0054550664,
        0.0009028906,
        0.013763956,
        0.024221413,
        0.019117335,
        -0.008686119,
        -0.013842682,
        -0.011487458,
        0.026110841,
        -0.0019632333,
        -0.0017450964,
        0.0044185054,
        -0.019248545,
        0.006711405,
        -0.023827782,
        0.007367456,
        -0.011349687,
        0.004953187,
        -0.005730608,
        -0.02315861,
        0.01703109,
        -0.014157587,
        -0.030152116,
        -0.0042446516,
        0.005428824,
        0.043561805,
        0.004963028,
        0.014052618,
        0.012832363,
        0.0064555444,
        -0.010090069,
        0.0075708316,
        -0.015194148,
        -0.0052877734,
        0.02904995,
        0.015181026,
        -0.004438187,
        -0.01087077,
        0.012720834,
        0.00051172,
        -0.013973893,
        -0.028603835,
        0.008266246,
        0.024273897,
        -0.007761087,
        -0.022883069,
        0.010831406,
        -0.04429658,
        0.024510076,
        -0.003975671,
        -0.011277521,
        -0.016913002,
        -0.0025799216,
        -0.023854025,
        0.009053508,
        -0.038575817,
        0.019878354,
        0.018211983,
        -0.017044213,
        -0.009801406,
        -0.000037056645,
        -0.01829071,
        0.0030867213,
        -0.012419051,
        0.014866122,
        -0.020219501,
        0.0072231246,
        0.023093006,
        0.008718922,
        -0.030152116,
        -0.0008815689,
        0.0070853536,
        0.014826759,
        -0.026701286,
        -0.0055961176,
        -0.007997265,
        0.010857648,
        0.012346885,
        0.0065441113,
        -0.008528667,
        -0.0075314688,
        -0.0111397505,
        -0.006317774,
        0.017674021,
        0.005284493,
        0.0006179183,
        -0.015141663,
        -0.0080694305,
        -0.025743453,
        -0.040229063,
        0.0037066897,
        0.0025225172,
        -0.018133257,
        -0.015587779,
        -0.0136327455,
        -0.0032392533,
        0.020114532,
        0.008128475,
        -0.014774275,
        0.009532425,
        0.03175288,
        -0.021308545,
        -0.006809812,
        -0.0055501936,
        0.011553063,
        -0.027344218,
        0.011467776,
        -0.006216086,
        -0.026071478,
        0.0017598575,
        -0.0181595,
        -0.010155674,
        -0.0012883208,
        0.014643065,
        0.013258796,
        0.014354402,
        -0.0008897695,
        0.028840015,
        0.020180138,
        0.004631722,
        -0.007741405,
        -0.015141663,
        0.0278953,
        -0.017437844,
        -0.0019091092,
        -0.007406819,
        -0.0044808304,
        0.002634046,
        -0.004694047,
        -0.002378186,
        -0.0038214987,
        -0.032776322,
        -0.016939243,
        0.003352422,
        0.006465385,
        -0.0062751304,
        -0.0022469757,
        -0.036161546,
        -0.01725415,
        -0.028236447,
        0.011047903,
        0.00972924,
        -0.023696572,
        0.0149710905,
        0.0021206858,
        0.0003952709,
        0.0064194617,
        -0.0055600344,
        -0.0076692393,
        -0.027711606,
        -0.009138795,
        -0.0068885386,
        -0.014826759,
        -0.0029407497,
        0.019983321,
        0.0017877397,
        -0.0038379,
        -0.016296314,
        -0.008974781,
        -0.026622562,
        -0.01982587,
        -0.012773318,
        0.0060717547,
        0.010542744,
        0.015404084,
        -0.0070853536,
        0.021361029,
        0.006622838,
        0.010516502,
        0.010037584,
        -0.021702176,
        0.014341281,
        -0.0013883685,
        0.014170707,
        0.007649558,
        -0.025677847,
        -0.0026832498,
        0.016204467,
        0.012366567,
        -0.009893253,
        0.020258864,
        0.0044611488,
        -0.008672998,
        -0.0124780955,
        -0.0042380914,
        -0.0042544925,
        0.008358093,
        0.023919629,
        -0.010582107,
        0.0048055756,
        0.00021178156,
        0.0010259002,
        0.0011702315,
        -0.00046538637,
        0.011598987,
        -0.012563382,
        0.018198863,
        -0.018828671,
        -0.010267203,
        0.0019763545,
        -0.020101411,
        0.031857852,
        -0.020652493,
        0.006868857,
        0.03776231,
        -0.00075650914,
        -0.002829221,
        -0.0011628509,
        -0.008745164,
        -0.012366567,
        0.004133123,
        -0.0038182184,
        -0.020495042,
        -0.01701797,
        -0.004454588,
        -0.008961661,
        -0.036633905,
        0.0039953524,
        -0.021374151,
        -0.005130321,
        0.0024159087,
        0.029942181,
        0.014052618,
        -0.03264511,
        -0.01087733,
        -0.015928926,
        0.012464974,
        0.0023011,
        -0.00971612,
        0.009965419,
        -0.004425066,
        0.0008725482,
        0.01829071,
        -0.011539942,
        -0.009243762,
        0.006691723,
        0.01342937,
        0.0026291255,
        0.03143798,
        0.21749412,
        -0.019655297,
        -0.008325291,
        0.03146422,
        0.011395611,
        0.017700264,
        0.0035000336,
        0.0021682496,
        0.00044939513,
        0.023066763,
        -0.019471603,
        0.007688921,
        -0.02225326,
        0.004110161,
        0.003045718,
        -0.002099364,
        -0.020508163,
        -0.024772497,
        -0.03634524,
        -0.027265491,
        0.001740176,
        -0.021347908,
        -0.034587022,
        -0.020901794,
        0.02174154,
        -0.0065834746,
        -0.015115421,
        -0.0068426146,
        0.037578616,
        0.013206312,
        -0.0038608618,
        -0.015797716,
        0.011494018,
        0.010929815,
        -0.01969466,
        -0.006921341,
        0.024588803,
        -0.0075511504,
        0.04167238,
        0.0104115335,
        -0.0098342085,
        -0.017175423,
        -0.0034344285,
        -0.0047891745,
        -0.0073740166,
        0.012392809,
        0.00959803,
        -0.031542946,
        0.024588803,
        0.027816575,
        -0.013042299,
        0.010464018,
        0.024615044,
        0.031149315,
        -0.00048137762,
        -0.003942868,
        0.009027266,
        0.009361852,
        -0.004523474,
        0.0010808444,
        -0.005412423,
        0.04007161,
        0.0017943003,
        0.032303967,
        -0.0179102,
        0.003427868,
        -0.019602813,
        -0.0049171043,
        0.0074265003,
        -0.020652493,
        -0.010050706,
        -0.0033064985,
        0.006809812,
        -0.007603634,
        -0.02596651,
        -0.023184853,
        0.018854914,
        0.009361852,
        0.024588803,
        0.032330208,
        0.0042020082,
        -0.00805631,
        0.013160389,
        -0.024457593,
        -0.038077217,
        -0.03314371,
        -0.013317841,
        0.013180071,
        -0.004756372,
        -0.016178224,
        -0.004385703,
        -0.025520395,
        -0.0011161072,
        -0.00035160247,
        0.025389185,
        0.027580395,
        0.0046546836,
        0.016794913,
        -0.021610329,
        0.01470867,
        -0.021426635,
        -0.012510898,
        0.0013900086,
        -0.0018533448,
        0.0015121982,
        0.018448163,
        -0.010536184,
        -0.0025503994,
        -0.0022682974,
        -0.0052057668,
        -0.010667394,
        -0.0158502,
        0.010208158,
        -0.0043266583,
        -0.0034245877,
        0.010142553,
        -0.021649692,
        -0.009735801,
        0.0040740785,
        -0.011789242,
        0.0050548753,
        -0.0119598145,
        -0.006868857,
        -0.002980113,
        -0.0049433466,
        -0.0045825182,
        -0.012714274,
        0.0074855452,
        0.009105992,
        -0.04167238,
        -0.0018320231,
        -0.0050384738,
        0.017739626,
        0.0042151297,
        0.0000632987,
        -0.006166882,
        0.012294401,
        -0.0018615455,
        -0.024011476,
        0.0040642377,
        0.00023822862,
        -0.01304886,
        -0.009709559,
        0.0023240617,
        -0.008554908,
        -0.007511787,
        0.038470846,
        -0.01714918,
        -0.014236312,
        0.0021338067,
        -0.030676957,
        -0.013619624,
        -0.002391307,
        -0.01726727,
        0.025756573,
        -0.018973002,
        -0.02815772,
        -0.0307032,
        0.008121915,
        -0.0010390212,
        -0.015404084,
        0.01522039,
        0.032723837,
        -0.011664592,
        -0.038811993,
        -0.026465109,
        -0.1706783,
        0.02326358,
        0.008607393,
        -0.022174533,
        0.022528801,
        0.020639373,
        0.031096831,
        0.0039723907,
        -0.0027734567,
        0.0032064507,
        -0.002455272,
        -0.013540898,
        -0.031936575,
        -0.009630833,
        -0.00028210206,
        -0.014380644,
        0.013960771,
        0.019773386,
        0.04080639,
        0.025100522,
        0.028866256,
        -0.016847396,
        0.020783704,
        -0.007459303,
        0.0068491753,
        -0.014905485,
        0.006458825,
        0.027501669,
        0.0019304309,
        -0.010083508,
        -0.019392876,
        -0.015889563,
        0.019091092,
        0.006202965,
        0.015154785,
        -0.008430259,
        0.0060455124,
        -0.0320153,
        -0.0022961795,
        0.026189568,
        0.027711606,
        0.013193191,
        0.008207202,
        -0.021584088,
        -0.010910133,
        0.0069279014,
        0.019025488,
        0.005825735,
        0.015469689,
        0.006465385,
        0.015587779,
        -0.010667394,
        -0.0046776454,
        0.004835098,
        0.020298226,
        0.013790198,
        0.006206245,
        0.024667528,
        0.007957902,
        -0.015390963,
        -0.005336977,
        -0.020954277,
        0.000086721775,
        -0.00857459,
        0.000934053,
        -0.00082580454,
        -0.010759241,
        0.010057266,
        -0.018736824,
        0.012635548,
        -0.005100799,
        -0.030283326,
        -0.009748922,
        -0.03366855,
        0.025376063,
        0.007459303,
        -0.029128676,
        0.023093006,
        -0.011454656,
        -0.0038739827,
        -0.0040019127,
        0.021006761,
        0.0012202554,
        0.010254081,
        -0.01100198,
        0.008692679,
        -0.005012232,
        0.009224081,
        -0.026950587,
        -0.014380644,
        0.017844595,
        -0.015154785,
        -0.00061996846,
        -0.017595295,
        0.0017385359,
        0.011106948,
        0.0061734426,
        0.015705867,
        -0.015955167,
        0.0014252714,
        -0.004054397,
        0.0074133794,
        -0.0047891745,
        0.008390896,
        0.03135925,
        -0.0028702244,
        0.026793133,
        0.01957657,
        0.017739626,
        -0.030073391,
        -0.025231732,
        0.014524975,
        0.020048928,
        0.021059247,
        0.016073257,
        0.029942181,
        -0.008364654,
        -0.017765868,
        0.0022059723,
        -0.0082531255,
        0.0317004,
        -0.00026283055,
        -0.034377087,
        0.0027094919,
        0.0033721037,
        0.0045890785,
        -0.06439799,
        -0.03429836,
        0.007964463,
        0.013075102,
        -0.009919495,
        0.02941734,
        -0.003506594,
        0.0044578686,
        -0.0004723569,
        0.019799627,
        0.011920452,
        -0.02763288,
        -0.019983321,
        -0.009748922,
        0.01995708,
        -0.02340791,
        -0.012609306,
        -0.001779539,
        -0.02175466,
        0.027291734,
        -0.007597074,
        -0.014170707,
        0.009683317,
        -0.0031392053,
        -0.025992751,
        0.004936786,
        -0.01112663,
        0.036765113,
        0.013960771,
        0.0001738536,
        -0.0150629375,
        -0.004999111,
        -0.00613736,
        0.00091437146,
        -0.00051172,
        0.0031834887,
        -0.04248588,
        0.029837212,
        0.011690834,
        -0.029469823,
        0.03849709,
        0.01087733,
        -0.005720767,
        -0.04314193,
        -0.0013859083,
        -0.0008873094,
        0.0016040454,
        0.04030779,
        0.005402582,
        -0.018448163,
        -0.018789308,
        -0.02865632,
        -0.024903707,
        0.0038182184,
        0.022056444,
        -0.0035131546,
        0.018592494,
        0.038418364,
        -0.01739848,
        0.007118156,
        0.019602813,
        0.0006855736,
        -0.02185963,
        0.012176312,
        -0.0073936977,
        0.000009507618,
        -0.017542811,
        0.010116311,
        0.02367033,
        0.011822044,
        -0.016178224,
        0.029758487,
        -0.009794845,
        0.0048547797,
        -0.028551351,
        0.0022879788,
        -0.004848219,
        -0.018815551,
        0.013514657,
        -0.019248545,
        -0.037893523,
        -0.016689945,
        -0.0076298765,
        -0.0042020082,
        0.02944358,
        0.014170707,
        -0.003670607,
        0.0073936977,
        -0.004621881,
        -0.031018104,
        -0.021137971,
        0.026648803,
        0.011303764,
        -0.008482743,
        0.010818286,
        0.004018314,
        -0.007846373,
        0.006386659,
        0.014433128,
        0.017713385,
        -0.01687364,
        -0.012491216,
        -0.06481787,
        0.027947785,
        -0.01165147,
        -0.010700196,
        0.016165104,
        0.0034573902,
        0.0066064363,
        -0.019025488,
        -0.0052976143,
        -0.0114152925,
        -0.03235645,
        -0.0027718167,
        -0.008423698,
        0.001879587,
        -0.035085622,
        -0.0073149716,
        0.028078996,
        0.013882045,
        0.020626253,
        0.01587644,
        0.009821088,
        -0.030467022,
        -0.010162234,
        0.007898858,
        -0.01956345,
        0.015404084,
        -0.024956191,
        0.00396255,
        -0.0043233777,
        -0.01241249,
        -0.0007347774,
        -0.03595161,
        -0.00075404893,
        0.027816575,
        0.0072362456,
        -0.000007880303,
        0.0015696026,
        0.02212205,
        0.00460548,
        0.029601034,
        -0.037447408,
        -0.019287908,
        0.013239115,
        -0.0018451442,
        0.0036181228,
        0.0056190793,
        -0.0086467555,
        -0.002991594,
        0.0204688,
        0.008023507,
        0.000086260494,
        0.026648803,
        -0.018710582,
        -0.025927147,
        -0.019786507,
        -0.018002046,
        -0.005015512,
        -0.0011062665,
        0.0009397935,
        -0.033852246,
        0.022725616,
        -0.009132233,
        0.020888673,
        -0.0015310596,
        0.0012177952,
        -0.004454588,
        -0.018002046,
        -0.006193124,
        -0.0066556404,
        -0.020783704,
        -0.011421853,
        -0.011198795,
        -0.001599125,
        0.01293077,
        0.025100522,
        0.013829561,
        -0.015561536,
        0.023460394,
        -0.035872884,
        0.024470713,
        0.015076058,
        0.015312237,
        -0.02225326,
        0.011723637,
        0.032330208,
        0.018120136,
        -0.00102344,
        -0.005655162,
        -0.003145766,
        0.011671152,
        -0.029364856,
        -0.012300962,
        0.0018139818,
        0.021833386,
        -0.008659877,
        0.00677701,
        0.016165104,
        0.012169751,
        0.030729441,
        0.012163191,
        0.012779878,
        0.009401215,
        -0.013645867,
        -0.013672109,
        -0.012819242,
        -0.0023683452,
        -0.0067376466,
        -0.030545747,
        -0.00409376,
        0.013258796,
        0.0041495245,
        0.018986125,
        0.011277521,
        0.013658987,
        -0.017608417,
        -0.0033212595,
        0.020022685,
        -0.011848286,
        -0.0409376,
        0.03595161,
        0.0020796827,
        0.0013449051,
        0.024470713,
        -0.009250323,
        0.019760264,
        0.005143442,
        0.00094963424,
        0.00422169,
        0.02201708,
        -0.00294403,
        0.014551218,
        -0.008226883,
        -0.008718922,
        -0.026307655,
        -0.013337523,
        0.0072624874,
        0.0036378044,
        0.029469823,
        -0.010011342,
        0.07216564,
        -0.0064391433,
        0.0069279014,
        0.01253714,
        0.021689055,
        0.024352623,
        0.018815551,
        0.017516568,
        -0.009184718,
        -0.034587022,
        -0.002112485,
        0.0119007705,
        -0.0016680104,
        -0.028787531,
        -0.018238226,
        -0.008036628,
        -0.025769694,
        0.0005067996,
        -0.010982298,
        0.00986045,
        0.009886693,
        0.007977583,
        0.012071343,
        0.0015851839,
        -0.017988926,
        -0.022358228,
        0.0110807065,
        0.012458414,
        -0.019799627,
        -0.039074413,
        0.005028633,
        0.0031523264,
        -0.00039711603,
        -0.01394765,
        0.0052024866,
        0.010070387,
        -0.0067442073,
        -0.0068163727,
        0.0153516,
        0.011100387,
        0.019353513,
        0.0050089513,
        -0.022200774,
        -0.03364231,
        0.013219433,
        0.001624547,
        -0.030335812,
        -0.0022338545,
        -0.011015101
      ]
    }
  ],
  "model": "text-embedding-ada-002-v2",
  "usage": {
    "prompt_tokens": 2,
    "total_tokens": 2
  }
}
""")
        } else {
          response.status(500).send("Unexpected Request!")
        }
      }
    }
  }

  def setupSpec() {
    OpenAIOkHttpClient.Builder b = OpenAIOkHttpClient.builder()
    if (Strings.isNullOrEmpty(openAiToken())) {
      // mock backend
      openAiBaseApi = "${mockOpenAiBackend.address.toURL()}/$API_VERSION"
      b.baseUrl(openAiBaseApi)
      b.credential(BearerTokenCredential.create(""))
    } else {
      // real openai backend
      b.credential(BearerTokenCredential.create(openAiToken()))
      openAiBaseApi = ClientOptions.PRODUCTION_URL
    }
    openAiClient = b.build()
  }

  CompletionCreateParams completionCreateParams() {
    CompletionCreateParams.builder()
        .model(CompletionCreateParams.Model.GPT_3_5_TURBO_INSTRUCT)
        .prompt("Tell me a story about building the best SDK!")
        .build()
  }

  ChatCompletionCreateParams chatCompletionCreateParams() {
    ChatCompletionCreateParams.builder()
        .model(ChatModel.GPT_4O_MINI)
        .addSystemMessage("")
        .addUserMessage("")
        .build()
  }

  EmbeddingCreateParams embeddingCreateParams() {
    EmbeddingCreateParams.builder()
      .model(EmbeddingModel.TEXT_EMBEDDING_ADA_002)
      .input("hello world")
      .build()
  }
}

