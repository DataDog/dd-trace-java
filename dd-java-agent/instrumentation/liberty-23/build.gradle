plugins {
  id 'java-test-fixtures'
  id 'com.github.johnrengelman.shadow' version '7.1.2'
}
muzzle {
  pass {
    group = "io.openliberty"
    module = 'openliberty-runtime'
    versions = "[21.0.0.3,)"
    assertInverse = true
  }
}
apply from: "$rootDir/gradle/java.gradle"

String relAppDir = 'openliberty-jars/wlp/usr/servers/defaultServer/dropins/war/testapp'
sourceSets {
  webapp {
    java {
      destinationDirectory.value project.layout.buildDirectory.dir("$relAppDir/WEB-INF/classes")
    }
    output.resourcesDir = project.layout.buildDirectory.dir("$relAppDir/")
  }
}

configurations {
  zipped
  testLogging
}

evaluationDependsOn ':dd-java-agent:instrumentation:servlet:request-5'

dependencies {
  // shadow group: 'io.openliberty', name: 'openliberty-runtime', version: '23.0.0.7', ext: 'zip'
  zipped group: 'io.openliberty', name: 'openliberty-runtime', version: '23.0.0.7', ext: 'zip'
  testLogging deps.testLogging

  compileOnly group: 'jakarta.servlet', name: 'jakarta.servlet-api', version: '5.0.0'
  compileOnly files({ tasks.installOpenLibertyDeps.extractedJars })
  //  compileOnly files({ tasks.shadowJar.archiveFile })
  implementation project(':dd-java-agent:instrumentation:servlet:request-5')
  testImplementation files({ tasks.installOpenLibertyDeps.wsServerJar })
  //testRuntimeOnly files({ tasks.shadowJar.archiveFile })
  testRuntimeOnly files({ tasks.installOpenLibertyDeps.extractedJars })

  testImplementation testFixtures(project(':dd-java-agent:appsec'))
  testRuntimeOnly project(':dd-java-agent:instrumentation:osgi-4.3')
  testRuntimeOnly files({ tasks.filterLogbackClassic.filteredLogbackDir })
  testRuntimeOnly project(':dd-java-agent:instrumentation:servlet:request-5')

  webappCompileOnly group: 'jakarta.servlet', name: 'jakarta.servlet-api', version: '5.0.0'
  // compileOnly to avoid bringing all the test dependencies to the test app
  // these are to be provided by the system classloader on test time
  webappCompileOnly project(':dd-java-agent:instrumentation:servlet:request-5')
    .tasks['compileTestFixturesJava'].classpath
  // only the testFixtures jar (not its dependencies) and groovy should be included in the webapp
  webappImplementation files(
    project(':dd-java-agent:instrumentation:servlet:request-5')
    .getTasksByName('testFixturesJar', false).archiveFile
    )
  // use the above instead of:
  //  webappImplementation testFixtures(project(':dd-java-agent:instrumentation:servlet:request-5'))
  // because using testFixtures() causes some early evaluation of dependencies
  webappRuntimeOnly deps.groovy
}
configurations {
  testRuntimeOnly {
    exclude group: 'org.slf4j', module: '**'
  }
}
compileWebappJava.dependsOn ':dd-java-agent:instrumentation:servlet:request-5:testFixturesJar'
configurations.testRuntimeOnly {
  //exclude group: 'ch.qos.logback', module: 'logback-classic'
  exclude group: 'org.codehaus.groovy', module: 'groovy-servlet'
}
configurations.webappRuntimeClasspath {
  exclude group: 'ch.qos.logback', module: 'logback-classic'
}
//unzips the dependencies from the 'zipped' configuration so 'compileOnly' can reference it
tasks.register('installOpenLibertyDeps', Copy) {
  def extractDir = "${buildDir}/openliberty-jars"
  ext.extractedJars = fileTree(extractDir) {
    include "wlp/lib/com.ibm.ws.kernel.boot_1.0.79.jar"
    include "wlp/lib/org.eclipse.osgi_3.18.300.jar"
    include "wlp/lib/com.ibm.ws.kernel.equinox.module_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.eclipse.equinox.region_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.kernel.service_1.3.79.jar"
    include "wlp/lib/com.ibm.ws.org.eclipse.equinox.metatype_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.config_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.objectweb.asm_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.eclipse.equinox.coordinator_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.felix.scr_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.event_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.runtime.update_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.threading_1.1.79.jar"
    include "wlp/lib/com.ibm.ws.kernel.metatype.helper_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.kernel.filemonitor_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.crypto.passwordutil_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.diagnostics_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.aries.jmx.core.whiteboard_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.aries.jmx.api_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.kernel.feature_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.aries.util_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.container.service_1.0.79.jar"
    include "wlp/lib/io.openliberty.webcontainer.security.internal_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.artifact.url_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.artifact.zip_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.artifact_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.credentials_1.0.79.jar"
    include "wlp/lib/com.ibm.websphere.security_1.1.79.jar"
    include "wlp/lib/com.ibm.ws.security.registry_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.registry.basic_1.0.79.jar"
    include "wlp/lib/io.openliberty.dynacache.internal_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.token_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.servlet.6.0_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.authentication_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.authorization_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.ready.service_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.mp.jwt.proxy_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.authorization.builtin_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.appbnd_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.javaee.dd_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.adaptable.module_1.0.79.jar"
    include "wlp/lib/io.openliberty.security.authorization.internal.jacc_1.0.79.jar"
    include "wlp/lib/io.openliberty.security.authorization.internal.jacc.ejb_1.0.79.jar"
    include "wlp/lib/io.openliberty.security.authorization.internal.jacc.web_1.0.79.jar"
    include "wlp/lib/io.openliberty.org.glassfish.hk2.osgi-resource-locator_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.classloading.configuration_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.artifact.equinox.module_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.artifact.overlay_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.resource_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.classloading_1.1.79.jar"
    include "wlp/lib/com.ibm.ws.anno_1.1.79.jar"
    include "wlp/lib/io.openliberty.mail.2.1.internal_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.channelfw_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.wsbytebuffer_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.timer_1.0.79.jar"
    include "wlp/lib/io.openliberty.org.hibernate.validator.7.0_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.app.manager_1.1.79.jar"
    include "wlp/lib/com.ibm.ws.app.manager.lifecycle_1.0.79.jar"
    include "wlp/lib/com.ibm.tx.jta.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.tx.embeddable.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.recoverylog_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.auth.data.common_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.kerberos.auth_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.messaging.common_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.messaging.utils_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jca.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.messaging.security.common_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.connectors.2.1_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.messaging.comms.client_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.app.manager.rar_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jca.1.7.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.aries.jndi.core_1.1.79.jar"
    include "wlp/lib/com.ibm.ws.jndi_1.0.79.jar"
    include "wlp/lib/io.openliberty.org.eclipse.persistence-3.1_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.aries.jndi.api_1.1.79.jar"
    include "wlp/lib/com.ibm.ws.org.slf4j.api_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.slf4j.jdk14_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.transport.http_1.0.79.jar"
    include "wlp/lib/../dev/api/third-party/io.openliberty.persistence.3.1.thirdparty_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jpa.container.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.app.manager.war.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.managedobject_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.injection.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.webcontainer.jakarta_1.1.79.jar"
    include "wlp/lib/com.ibm.ws.webcontainer.servlet.3.1.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.session.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.webcontainer.cors.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.http.plugin.merge_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.webserver.plugin.runtime.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.webserver.plugin.runtime.interfaces_1.0.79.jar"
    include "wlp/lib/io.openliberty.accesslists.internal_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.persistence.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.persistence.mbean_1.0.79.jar"
    include "wlp/lib/io.openliberty.webcontainer.servlet.6.0.internal.factories_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.webcontainer.servlet.4.0.jakarta_1.0.79.jar"
    include "wlp/lib/io.openliberty.webcontainer.servlet.6.0.internal_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.cdi.internal.jakarta_1.0.79.jar"
    include "wlp/lib/io.openliberty.cdi.4.0.internal.weld_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jsf.shared.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.yoko.osgi.1.5_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.yoko.corba.spec.1.5_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.javaee.dd.common_1.1.79.jar"
    include "wlp/lib/com.ibm.ws.serialization_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.yoko.rmi.spec.1.5_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.app.manager.ejb_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.wsoc.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.wsoc.2.1.jakarta_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.websocket.client.2.1_1.0.79.jar"
    include "wlp/lib/io.openliberty.wsoc.2.1.internal_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.websocket.2.1_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.beanvalidation.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.beanvalidation.v20.jakarta_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.validation.3.0_1.0.79.jar"
    include "wlp/lib/io.openliberty.org.jboss.resteasy.cdi.ee10_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.restfulWS.3.1_1.0.79.jar"
    include "wlp/lib/io.openliberty.org.jboss.resteasy.common.ee10_1.0.79.jar"
    include "wlp/lib/io.openliberty.org.jboss.resteasy.server.ee10_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.concurrency.policy_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.com.fasterxml.classmate_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.concurrent.jakarta_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.concurrency.3.0_1.0.79.jar"
    include "wlp/lib/../dev/api/stable/io.openliberty.org.eclipse.microprofile.contextpropagation.1.3_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.context_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jsp.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.cxf.cxf.core.3.2.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.messaging.runtime_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jaxws.webcontainer.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jaxws.web.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jaxws.wsat_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jaxws.2.3.common.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.messaging.comms.server_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.neethi.3.1.1_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.cxf.cxf.rt.ws.policy.3.2.jakarta_1.0.79.jar"
    include "wlp/lib/io.openliberty.concurrent.internal_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.yoko.rmi.impl.1.5_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.yoko.core.1.5_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.javaee.version_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.clientcontainer.remote.common_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.transport.iiop_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.cdi.interfaces.jakarta_1.0.79.jar"
    include "wlp/lib/io.openliberty.jbatch.2.1.cdi_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jca.resourcedefinition.jms.2.0.jakarta_1.0.79.jar"
    include "wlp/lib/io.openliberty.el.internal.cdi.jakarta_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.expressionLanguage.5.0_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.cdi.web.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.cdi.weld.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.cdi.ejb.common.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.cdi.2.0.ejb.jakarta_1.0.79.jar"
    include "wlp/lib/io.openliberty.org.jboss.weld5_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.cdi.4.0_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jaxws.cdi.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.ejbcontainer.jakarta_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.enterpriseBeans.4.0_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.wsoc.cdi.weld.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.messaging.msgstore.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.beanvalidation.v20.cdi.jakarta_1.0.79.jar"
    include "wlp/lib/io.openliberty.org.hibernate.validator.cdi.7.0_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jca.utils.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.messaging.jms.common.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.ejbcontainer.remote.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.cdi.jndi.jakarta_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.annotation.2.1_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.mail.2.1_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.messaging.3.1_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jmx_1.0.79.jar"
    include "wlp/lib/io.openliberty.cdi.4.0.internal.web_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.management.security_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.ssl_1.5.79.jar"
    include "wlp/lib/com.ibm.ws.crypto.certificateutil_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.crypto.certificate.creator.selfsigned_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.token.ltpa_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.crypto.ltpakeyutil_1.0.79.jar"
    include "wlp/lib/io.openliberty.security.jaas.internal.common_1.0.79.jar"
    include "wlp/lib/io.openliberty.security.authentication.internal.builtin_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.dynamic.bundle_1.0.79.jar"
    include "wlp/lib/io.openliberty.jcache.internal_1.0.79.jar"
    include "wlp/lib/com.ibm.websphere.security.impl_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.quickstart_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.webcontainer.security.feature_1.0.79.jar"
    include "wlp/lib/io.openliberty.security.sso.internal_1.0.79.jar"
    include "wlp/lib/io.openliberty.security.authentication.internal.filter_1.0.79.jar"
    include "wlp/lib/io.openliberty.security.common.internal_1.0.79.jar"
    include "wlp/lib/io.openliberty.security.jakartasec.2.0.internal_1.0.79.jar"
    include "wlp/lib/io.openliberty.security.jaspic.2.0.internal_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.authentication.3.0_1.0.79.jar"
    include "wlp/lib/io.openliberty.security.jakartasec.2.0.internal.cdi_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.security.3.0_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.channel.ssl_1.0.79.jar"
    include "wlp/lib/io.openliberty.security.oidcclientcore.internal.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.json4j_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.jose4j_1.0.79.jar"
    include "wlp/lib/io.openliberty.security.jakartasec.3.0.internal.cdi_1.0.79.jar"
    include "wlp/lib/io.openliberty.ejbcontainer.security.internal_1.0.79.jar"
    include "wlp/lib/io.openliberty.restfulWS.internal.ssl_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.csiv2.common_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.cdi.security_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.csiv2_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.transport.iiop.transaction.jakarta_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.transaction.2.0_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.transaction.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.tx.util.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.rls.jdbc.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.cxf.cxf.rt.transports.http.3.2.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.cxf.cxf.rt.wsdl.3.2.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.cxf.cxf.rt.transports.http.hc.3.2_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.cxf.cxf.rt.ws.addr.3.2.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.cxf.cxf.rt.bindings.soap.3.2.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.cxf.cxf.rt.frontend.jaxws.3.2.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.cxf.cxf.rt.bindings.xml.3.2.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.cxf.cxf.rt.frontend.simple.3.2.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.cxf.cxf.rt.databinding.jaxb.3.2.jakarta_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.xmlWS.4.0_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.clientcontainer.remote.server_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.cxf.cxf.rt.management.3.2.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.yoko.util.1.5_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jaxws.ejb.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jaxws.security_1.0.79.jar"
    include "wlp/lib/io.openliberty.faces.4.0.internal_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.faces.4.0_1.0.79.jar"
    include "wlp/lib/io.openliberty.pages.3.1.internal.factories_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jsf.beanvalidation.jakarta_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.xmlBinding.4.0_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jndi.iiop_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jca.cm.jakarta_1.1.79.jar"
    include "wlp/lib/com.ibm.ws.messaging.jms.2.0.jakarta_2.0.79.jar"
    include "wlp/lib/com.ibm.ws.javaee.metadata.context_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.context_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.transaction.context.jakarta_1.0.79.jar"
    include "wlp/lib/io.openliberty.handlelist.context.internal_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.classloader.context_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.ejbcontainer.mdb.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.app.manager.module_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.app.manager.client_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.clientcontainer.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.ejbcontainer.war_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.app.manager.wab.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.eba.wab.integrator_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.app.manager.ready_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.artifact.loose_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.artifact.file_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.javaee.ddmodel_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jndi.url.contexts_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.javaee.dd.ejb_1.1.79.jar"
    include "wlp/lib/com.ibm.ws.ejbcontainer.session_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.managedbeans_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.webservices.javaee.common.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.javaee.ddmodel.ws_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.javaee.ddmodel.wsbnd_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.authorization.2.1_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.interceptor.2.1_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.cdi.transaction.jakarta_1.0.79.jar"
    include "wlp/lib/io.openliberty.transaction.internal.cdi20.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.artifact.bundle_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.messaging.jms.2.0.cdi.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.jpa.container.v21.cdi.jakarta_1.0.79.jar"
    include "wlp/lib/io.openliberty.concurrent.internal.cdi_1.0.79.jar"
    include "wlp/lib/io.openliberty.org.apache.myfaces.4.0_1.0.79.jar"
    include "wlp/lib/com.ibm.jbatch.container.jakarta.ee10_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.pages.3.1_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.batch.2.1_1.0.79.jar"
    include "wlp/lib/io.openliberty.org.apache.jasper.expressionLanguage.5.0_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.javaee.metadata.context.ejb_1.0.79.jar"
    include "wlp/lib/io.openliberty.security.jakartasec.3.0.internal_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.jboss.classfilewriter_1.2.79.jar"
    include "wlp/lib/com.ibm.ws.jpa.container.eclipselink.jakarta_1.0.79.jar"
    include "wlp/lib/io.openliberty.session.6.0.internal_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.collector.manager_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.credentials.ssotoken_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.security.credentials.wscred_1.0.79.jar"
    include "wlp/lib/io.openliberty.restfulWS30.jsonb20provider_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.jsonb.3.0_1.0.79.jar"
    include "wlp/lib/io.openliberty.org.eclipse.yasson.3.0_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.jsonp.2.1_1.0.79.jar"
    include "wlp/lib/io.openliberty.org.eclipse.parsson.1.1_1.0.79.jar"
    include "wlp/lib/io.openliberty.org.jboss.resteasy.jaxb.provider.ee10_1.0.79.jar"
    include "wlp/lib/io.openliberty.org.jboss.resteasy.validator.provider.ee10_1.0.79.jar"
    include "wlp/lib/../dev/api/ibm/io.openliberty.jaxrs30_1.0.79.jar"
    include "wlp/lib/../dev/api/spec/io.openliberty.jakarta.activation.2.1_1.0.79.jar"
    include "wlp/lib/../dev/api/stable/com.ibm.websphere.org.reactivestreams.reactive-streams.1.0_1.1.79.jar"
    include "wlp/lib/io.openliberty.restfulWS30.appSecurity_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.ejbcontainer.timer.persistent.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.concurrent.persistent.jakarta_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.org.apache.cxf.cxf.rt.features.logging.3.2_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.logging_1.0.79.jar"
    include "wlp/lib/com.ibm.ws.logging.osgi_1.0.79.jar"
    include "wlp/lib/io.openliberty.org.jboss.logging35_1.0.79.jar"
    builtBy "installOpenLibertyDeps"
  }
  ext.wsServerJar = fileTree("$extractDir") {
    include "wlp/bin/tools/ws-server.jar"
    builtBy "installOpenLibertyDeps"
  }
  dependsOn configurations.zipped
  // I didn't manage to get this to work correctly using a Sync task or Sync + outputs.upToDateWhen
  // (files are updated when not needed, causing intellij to reindex or they are deemed up to date
  // when the extraction was not done at all).
  ext.serverXmlFile = file("$extractDir/wlp/usr/servers/defaultServer/server.xml")
  onlyIf {
    !ext.serverXmlFile.exists()
  }
  from {
    configurations.zipped.collect { zipTree(it) }
  }
  eachFile { fcd ->
    fcd.path = fcd.path.replaceAll(/\/templates\/(servers\/defaultServer\/.+)/, '/usr/$1')
  }
  into extractDir
  outputs.file ext.serverXmlFile
}
[test, forkedTest]*.dependsOn webappClasses, installOpenLibertyDeps
[test, forkedTest].each {
  it.configure {
    jvmArgs += ["-Dserver.xml=${installOpenLibertyDeps.serverXmlFile.absoluteFile}"]
  }
}

tasks.register('webappCopyJars', Sync) {
  from configurations.webappRuntimeClasspath.findAll { it.name.endsWith('.jar') }
  into project.layout.buildDirectory.dir("$relAppDir/WEB-INF/lib")
  dependsOn ':dd-java-agent:instrumentation:servlet:request-5:testFixturesJar'
}
[test, forkedTest]*.dependsOn webappCopyJars

tasks.register('filterLogbackClassic', Sync) {
  ext.filteredLogbackDir = project.layout.buildDirectory.dir('filteredLogback')
  from configurations.testLogging
    .findAll { it.name.contains('logback-') }
    .collect { zipTree(it) }
  exclude 'META-INF/**'
  into ext.filteredLogbackDir
}
[test, forkedTest]*.dependsOn filterLogbackClassic

//shadowJar {
//    zip64 true
//    archiveFileName = 'openliberty-shadow.jar'
//
//    // Exclude DataDog packages, Byte Buddy packages, OkHttp3 packages
//    exclude 'jnr/**'
//    exclude 'datadog/**'
//    exclude 'com/datadoghq/sketch/**'
//    exclude 'com/squareup/moshi/**'
//    exclude 'com/datadog/**'
//    exclude 'net/bytebuddy/**'
//    exclude 'okhttp3/**'
//    // Exclude META-INF and WEB-INF directories
//    exclude 'META-INF/**'
//    exclude 'WEB-INF/**'
//
//    // Include JAR files from the 'lib' directory
//    from("${buildDir}/openliberty-jars") {
//        include "wlp/lib/*.jar"
//        include "wlp/dev/*.jar"
//    }
//}
//test.dependsOn shadowJar