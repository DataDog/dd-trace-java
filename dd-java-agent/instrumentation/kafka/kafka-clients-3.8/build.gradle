ext {
  minJavaVersionForTests = JavaVersion.VERSION_17
}

muzzle {
  pass {
    group = "org.apache.kafka"
    module = "kafka-clients"
    versions = "[3.8.0,)"
    assertInverse = true
    javaVersion = "17"
  }
}

apply from: "$rootDir/gradle/java.gradle"

addTestSuiteForDir('latestDepTest', 'test')
addTestSuiteExtendingForDir('latestDepForkedTest', 'latestDepTest', 'test')

["compileMain_java17Java", "compileTestJava", "compileLatestDepTestJava"].each {
  tasks.named(it, JavaCompile) {
    configureCompiler(it, 17, JavaVersion.VERSION_1_8)
  }
}

tasks.withType(JavaCompile).configureEach {
  configureCompiler(it, 17, JavaVersion.VERSION_1_8)
}

tasks.withType(GroovyCompile).configureEach {
  configureCompiler(it, 17)
}

dependencies {
  implementation project(':dd-java-agent:instrumentation:kafka:kafka-common')
  implementation project(':dd-java-agent:instrumentation:span-origin')

  main_java17CompileOnly instrumentedLibs.kafka.clients.v3
  main_java17Implementation project(':dd-java-agent:instrumentation:kafka:kafka-common')

  testImplementation(instrumentedLibs.spring.kafka.v3) {
    exclude group: 'org.apache.kafka'
  }
  testImplementation(instrumentedLibs.spring.kafka.test.v3) {
    exclude group: 'org.apache.kafka'
  }

  testImplementation instrumentedLibs.kafka.server.common.v3.test

  testImplementation instrumentedLibs.kafka.clients.v3
  testImplementation "${instrumentedLibs.kafka.clients.v3.get().module}:${instrumentedLibs.kafka.clients.v3.get().version}:test"

  testImplementation instrumentedLibs.kafka.v2.v3
  testImplementation "${instrumentedLibs.kafka.v2.v3.get().module}:${instrumentedLibs.kafka.v2.v3.get().version}:test"

  testImplementation instrumentedLibs.jaxb.api.v2
  testImplementation instrumentedLibs.mockito.core.v2
  testRuntimeOnly project(':dd-java-agent:instrumentation:spring:spring-scheduling-3.1')

  latestDepTestImplementation instrumentedLibs.spring.kafka.latest.v3x
  latestDepTestImplementation instrumentedLibs.spring.kafka.test.latest.v3x
  latestDepTestImplementation instrumentedLibs.dropwizard.metrics.latest
  latestDepTestImplementation libs.guava
}
