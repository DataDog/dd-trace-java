muzzle {
  pass {
    coreJdk()
  }
}

apply from: "$rootDir/gradle/java.gradle"

addTestSuite('classloadingJbossTest')
addTestSuite('classloadingTomcatTest')
addTestSuiteExtendingForDir('classloadingTomcatLatestDepTest', 'classloadingTomcatTest', 'classloadingTomcatTest')
addTestSuite('classloadingOsgiTest')
addTestSuite('classloadingJsr14Test')

tasks.named("classloadingJbossTest") {
  testJvmConstraints {
    // TODO Java 17: This version of jboss-modules doesn't support Java 17
    //  __redirected.__SAXParserFactory can't access com.sun.org.apache.xerces.internal.jaxp
    maxJavaVersion = JavaVersion.VERSION_15
  }
}

tasks.named("classloadingTomcatLatestDepTest") {
  testJvmConstraints {
    minJavaVersion = JavaVersion.VERSION_17
  }
}

dependencies {
  classloadingJbossTestImplementation group: 'org.jboss.modules', name: 'jboss-modules', version: '1.3.10.Final'
  classloadingJsr14TestImplementation files('src/classloadingJsr14Test/precompiled')
  // TODO: we should separate core and Eclipse tests at some point,
  // but right now core-specific tests are quite dump and are run with
  // core version provided by Eclipse implementation.
  //testImplementation group: 'org.osgi', name: 'org.osgi.core', version: '4.0.0'
  classloadingOsgiTestImplementation group: 'org.eclipse.platform', name: 'org.eclipse.osgi', version: '3.13.200'
  classloadingOsgiTestImplementation group: 'org.apache.felix', name: 'org.apache.felix.framework', version: '6.0.2'
  //This seems to be the earliest version that has org.apache.catalina.loader.WebappClassLoaderBase
  //Older versions would require slightly different instrumentation.
  classloadingTomcatTestImplementation group: 'org.apache.tomcat', name: 'tomcat-catalina', version: '8.0.14'

  // Tomcat 10.1.+ seems to require Java 11. Limit to fix build.
  classloadingTomcatLatestDepTestImplementation group: 'org.apache.tomcat', name: 'tomcat-catalina', version: '+'
}
