package com.datadog.iast.model.json;

import com.datadog.iast.model.VulnerabilityBatch;
import com.datadog.iast.model.json.TruncatedVulnerabilitiesAdapter.TruncatedVulnerabilities;
import com.squareup.moshi.JsonAdapter;
import com.squareup.moshi.Moshi;

public class VulnerabilityEncoding {

  static final Moshi MOSHI =
      new Moshi.Builder().add(new SourceTypeAdapter()).add(new AdapterFactory()).build();

  private static final JsonAdapter<VulnerabilityBatch> BATCH_ADAPTER =
      MOSHI.adapter(VulnerabilityBatch.class);

  public static String toJson(final VulnerabilityBatch value) {
    String json = BATCH_ADAPTER.toJson(value);
    return json.getBytes().length > 25000
        ? getExceededTagSizeJson(new TruncatedVulnerabilities(value.getVulnerabilities()))
        : json;
  }

  static String getExceededTagSizeJson(final TruncatedVulnerabilities truncatedVulnerabilities) {
    // TODO report via telemetry
    return MOSHI.adapter(TruncatedVulnerabilities.class).toJson(truncatedVulnerabilities);
  }
}
