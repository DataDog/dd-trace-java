package com.datadog.iast.model;

import java.io.File;
import java.util.zip.CRC32;
import javax.annotation.Nonnull;

public interface VulnerabilityType {
  VulnerabilityType WEAK_CIPHER = new VulnerabilityTypeImpl("WEAK_CIPHER");
  VulnerabilityType WEAK_HASH = new VulnerabilityTypeImpl("WEAK_HASH");
  InjectionType SQL_INJECTION = new InjectionTypeImpl("SQL_INJECTION", ' ');
  InjectionType COMMAND_INJECTION = new InjectionTypeImpl("COMMAND_INJECTION", ' ');
  InjectionType PATH_TRAVERSAL = new InjectionTypeImpl("PATH_TRAVERSAL", File.separatorChar);
  InjectionType LDAP_INJECTION = new InjectionTypeImpl("LDAP_INJECTION", ' ');

  String name();

  long calculateHash(@Nonnull final Vulnerability vulnerability);

  interface InjectionType extends VulnerabilityType {
    char evidenceSeparator();
  }

  class VulnerabilityTypeImpl implements VulnerabilityType {

    private final String name;

    public VulnerabilityTypeImpl(@Nonnull final String name) {
      this.name = name;
    }

    @Override
    public String name() {
      return name;
    }

    @Override
    public long calculateHash(@Nonnull final Vulnerability vulnerability) {
      CRC32 crc = new CRC32();
      crc.update(name().getBytes());
      final Location location = vulnerability.getLocation();
      if (location != null) {
        crc.update(location.getLine());
        crc.update(location.getPath().getBytes());
      }
      return crc.getValue();
    }
  }

  class InjectionTypeImpl extends VulnerabilityTypeImpl implements InjectionType {
    private final char evidenceSeparator;

    public InjectionTypeImpl(@Nonnull final String name, final char evidenceSeparator) {
      super(name);
      this.evidenceSeparator = evidenceSeparator;
    }

    @Override
    public char evidenceSeparator() {
      return evidenceSeparator;
    }
  }
}
