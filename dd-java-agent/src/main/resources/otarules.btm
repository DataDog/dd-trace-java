	# --------------------------------------------------------
# Instrument mongo client
RULE Mongo Client instrumentation
CLASS com.mongodb.MongoClientOptions$Builder
METHOD build()
HELPER io.opentracing.contrib.agent.OpenTracingHelper
BIND
  listener:io.opentracing.contrib.mongo.TracingCommandListener =
        new io.opentracing.contrib.mongo.TracingCommandListener(getTracer());
AT ENTRY
IF TRUE
DO
  $this.addCommandListener(listener);
ENDRULE

# --------------------------------------------------------
# Instrument AWS client
RULE AWS SDK Client instrumentation 1
CLASS ^com.amazonaws.client.builder.AwsClientBuilder
METHOD build()
HELPER io.opentracing.contrib.agent.OpenTracingHelper
BIND
  requestTracerHandler:io.opentracing.contrib.aws.TracingRequestHandler = new io.opentracing.contrib.aws.TracingRequestHandler(getTracer());
  requests:java.util.List = new java.util.ArrayList();
AT ENTRY
IF $this.requestHandlers == null
DO
  requests.add(requestTracerHandler);
  $this.requestHandlers = requests;
ENDRULE

RULE AWS SDK Client instrumentation 2
CLASS ^com.amazonaws.client.builder.AwsClientBuilder
METHOD build()
HELPER io.opentracing.contrib.agent.OpenTracingHelper
BIND
  requestTracerHandler:io.opentracing.contrib.aws.TracingRequestHandler = new io.opentracing.contrib.aws.TracingRequestHandler(getTracer());
AT ENTRY
IF $this.requestHandlers != null AND $this.requestHandlers.get(0).getClass().getCanonicalName() != "io.opentracing.contrib.aws.TracingRequestHandler"
DO
  $this.requestHandlers.add(0, requestTracerHandler);
ENDRULE

# --------------------------------------------------------
# Instrument Apache HTTP Client
RULE Apache HTTP Client instrumentation
CLASS org.apache.http.impl.client.HttpClientBuilder
METHOD decorateProtocolExec(org.apache.http.impl.execchain.ClientExecChain)
HELPER io.opentracing.contrib.agent.OpenTracingHelper
BIND
  redirectStrategy: org.apache.http.client.RedirectStrategy = $this.redirectStrategy==null?org.apache.http.impl.client.DefaultRedirectStrategy.INSTANCE:$this.redirectStrategy;
  decorators: java.util.List = java.util.Collections.singletonList(new io.opentracing.contrib.apache.http.client.ApacheClientSpanDecorator$StandardTags());
  tracingClientExec:io.opentracing.contrib.apache.http.client.TracingClientExec 
  							= new io.opentracing.contrib.apache.http.client.TracingClientExec($1,redirectStrategy,$this.redirectHandlingDisabled,getTracer(),decorators);
AT ENTRY
IF TRUE
DO
  return tracingClientExec;
ENDRULE


# --------------------------------------------------------
# Cassandra
RULE Cassandra
CLASS com.datastax.driver.core.Cluster$Manager
METHOD newSession()
HELPER io.opentracing.contrib.agent.helper.CassandraHelper
#BIND
AT EXIT
IF TRUE
DO
   $! = patch($!);
ENDRULE
